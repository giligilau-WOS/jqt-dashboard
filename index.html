<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯’éœœå•Ÿç¤ºéŒ„ jQtè¯ç›Ÿ | æˆ°è¡“æŒ‡æ®ä¸­å¿ƒ v68.1 (HUD Dashboard)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ice: { 50: '#f0f9ff', 100: '#e0f2fe', 800: '#075985', 900: '#0c4a6e' },
                        furnace: { 500: '#f97316', 600: '#ea580c', 700: '#c2410c' }
                    },
                    animation: {
                        'highlight': 'highlight 1s ease-in-out',
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer components {
            .nav-btn { @apply px-4 py-2 md:px-6 md:py-3 rounded-t-lg font-bold text-sm md:text-base transition-all border-b-4 border-transparent text-slate-500 hover:text-slate-800 hover:bg-slate-50; }
            .nav-btn.active { @apply bg-white text-indigo-700 border-indigo-600 shadow-sm translate-y-[1px]; }
            
            /* --- DASHBOARD COMPONENTS --- */
            .stat-card { @apply bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center gap-4 transition-all duration-300 hover:shadow-md hover:-translate-y-1; }
            .stat-icon-box { @apply w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-inner; }
            
            .team-col-header { @apply sticky top-0 bg-white/95 backdrop-blur z-20 p-3 border-b shadow-sm; }
            .team-container { @apply bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden flex flex-col h-[75vh] transition-all duration-300; }
            .team-container:hover { @apply shadow-lg border-slate-300; }
            
            .member-card { 
                @apply relative bg-white p-2.5 mb-2 rounded-xl border border-slate-100 shadow-sm transition-all duration-200 cursor-pointer select-none overflow-hidden; 
            }
            .member-card:hover { @apply transform scale-[1.02] shadow-md z-10 border-indigo-200; }
            .member-card:active { @apply scale-95; }
            
            /* Power Bar Background */
            .power-bar-bg { @apply absolute left-0 top-0 bottom-0 bg-current opacity-[0.08] transition-all duration-500; }
            
            /* Badges */
            .mini-badge { @apply text-[10px] px-1.5 py-0.5 rounded font-bold uppercase tracking-wider border; }
            
            /* Input Styles (from previous) */
            .input-group-card { @apply p-6 rounded-xl border-2 transition-all duration-300 hover:shadow-lg relative overflow-hidden; }
            .modern-input { @apply w-full p-4 border-2 border-slate-200 rounded-xl font-mono text-sm transition-all focus:ring-4 focus:outline-none; }
            
            /* Custom Scrollbar */
            .custom-scroll::-webkit-scrollbar { width: 6px; }
            .custom-scroll::-webkit-scrollbar-track { background: transparent; }
            .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
            .custom-scroll:hover::-webkit-scrollbar-thumb { background-color: #94a3b8; }
            
            /* Attendance Styles */
            .att-btn { @apply w-8 h-8 rounded-full flex items-center justify-center border transition-all hover:scale-110 active:scale-95; }
            .att-btn.present { @apply border-green-500 text-green-500 hover:bg-green-50; }
            .att-btn.present.active { @apply bg-green-500 text-white shadow-md shadow-green-200; }
            .att-btn.absent { @apply border-red-500 text-red-500 hover:bg-red-50; }
            .att-btn.absent.active { @apply bg-red-500 text-white shadow-md shadow-red-200; }
            .att-btn.leave { @apply border-amber-500 text-amber-500 hover:bg-amber-50; }
            .att-btn.leave.active { @apply bg-amber-500 text-white shadow-md shadow-amber-200; }
        }
    </style>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #0f172a; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 24px 24px; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; font-size: 20px; }
        
        /* Tooltip */
        #member-tooltip { background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1); }
        
        body.dark { background-color: #0f172a; color: #e2e8f0; background-image: radial-gradient(#334155 1px, transparent 1px); }
        body.dark .glass-panel { background: rgba(30, 41, 59, 0.95); border-color: rgba(255,255,255,0.1); color: #e2e8f0; }
        body.dark .stat-card { background: #1e293b; border-color: #334155; }
        body.dark .team-container { background: #0f172a; border-color: #334155; }
        body.dark .team-col-header { background: rgba(30, 41, 59, 0.95); }
        body.dark .member-card { background: #1e293b; border-color: #334155; }
        body.dark .member-card:hover { border-color: #6366f1; }
    </style>
</head>
<body class="min-h-screen flex flex-col transition-colors duration-300">

    <div id="toast-container"></div>

    <div id="member-tooltip" class="fixed z-[9999] text-white p-4 rounded-xl shadow-2xl w-72 pointer-events-none transition-all duration-150 ease-out opacity-0 scale-95 left-0 top-0">
        <div class="flex justify-between items-start mb-3 border-b border-slate-600 pb-2">
            <div>
                <h4 class="font-black text-xl text-yellow-400 tracking-wide" id="tip-name">Player</h4>
                <div class="text-xs text-slate-400 mt-0.5" id="tip-fid">Family</div>
            </div>
            <span class="text-xs bg-indigo-600 px-2 py-1 rounded text-white font-bold shadow-sm" id="tip-team">Team</span>
        </div>
        <div class="space-y-3 text-sm">
    <div class="flex justify-between items-center bg-slate-800/80 p-2 rounded border border-slate-700">
        <span class="text-slate-300">ğŸ“Š æˆ°åŠ›è©•åƒ¹</span>
        <span class="font-black text-white text-base" id="tip-quality">Common</span>
    </div>

    <div class="flex justify-between items-start gap-4">
        <span class="text-slate-400 shrink-0">ğŸ“ åŸå§‹å¿—é¡˜</span>
        <span class="font-bold text-amber-300 text-right break-words leading-tight" id="tip-orig-pref">--</span>
    </div>
    <div class="flex justify-between items-center">
        <span class="text-slate-400">ğŸ’ª è¯ç›Ÿç¸½ä½”æ¯”</span>
        <span class="font-mono font-bold text-blue-400" id="tip-pct">0%</span>
    </div>
</div>>
    </div>

    <div id="team-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-black text-slate-800">ğŸ›ï¸ é¸æ“‡åƒæˆ°è»åœ˜</h3>
                <button onclick="toggleTeamModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex gap-2 mb-4">
                    <button onclick="toggleAllTeams(true)" class="text-xs bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded font-bold text-slate-600">å…¨é¸</button>
                    <button onclick="toggleAllTeams(false)" class="text-xs bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded font-bold text-slate-600">å…¨ä¸é¸</button>
                </div>
                <div id="team-select-container" class="grid grid-cols-1 gap-3"></div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex justify-end gap-3">
                <button onclick="toggleTeamModal()" class="px-4 py-2 text-slate-600 font-bold hover:bg-slate-200 rounded">å–æ¶ˆ</button>
                <button onclick="applyTeamSelection()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded shadow">å¥—ç”¨ä¸¦é‡æ–°åˆ†é…</button>
            </div>
        </div>
    </div>

    <header class="bg-slate-900 text-white shadow-lg z-50 sticky top-0">
        <div class="max-w-[1920px] mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center h-auto md:h-16 py-2 md:py-0">
                <div class="flex items-center gap-3 mb-2 md:mb-0">
                    <span class="text-2xl animate-float">ğŸ°</span>
                    <div>
                        <h1 class="font-black text-lg tracking-wide">jQt è¯ç›Ÿå…µå·¥å» </h1>
                        <p class="text-[9px] text-slate-400 uppercase tracking-widest">COMMANDER v68.1 (HUD)</p>
                    </div>
                </div>
                <div class="flex gap-1 self-end w-full md:w-auto overflow-x-auto items-center">
                    <button onclick="switchTab('input')" id="nav-input" class="nav-btn active">ğŸ“¥ è³‡æ–™</button>
                    <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn hidden">1. æˆ°åŠ›</button>
                    <button onclick="switchTab('tactics')" id="nav-tactics" class="nav-btn hidden">2. ä»»å‹™</button>
                    <button onclick="switchTab('attendance')" id="nav-attendance" class="nav-btn hidden">3. é»å</button>
                    <button onclick="switchTab('history')" id="nav-history" class="nav-btn">ğŸ’¾ å­˜æª”</button>
                    <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn">âš™ï¸ è¨­å®š</button>
                    <button onclick="toggleDarkMode()" class="ml-2 p-2 rounded-full hover:bg-slate-800" title="åˆ‡æ›æ·±è‰²æ¨¡å¼">ğŸŒ—</button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow bg-slate-100 p-2 md:p-4 overflow-y-auto custom-scroll transition-colors duration-300">
        <div class="max-w-[1920px] mx-auto">

            <section id="page-input" class="space-y-6 animate-fade-in max-w-5xl mx-auto mt-8">
                <div class="glass-panel p-8 rounded-2xl bg-white shadow-xl">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center gap-2 bg-slate-100 rounded-full px-4 py-1.5 mb-4 shadow-inner">
                            <span class="text-xs font-bold text-slate-500">VERSION 68.1</span>
                            <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                            <span class="text-xs text-indigo-500 font-bold">âœ¨ HUD DASHBOARD</span>
                        </div>
                        <h2 class="text-3xl md:text-4xl font-black text-slate-800 mb-4 tracking-tight">è³‡æ–™ä¾†æºåŒæ­¥</h2>
                        
                        <div class="flex justify-center gap-4 mt-6">
                            <button onclick="switchInputMode('cloud')" id="mode-cloud" class="group relative px-6 py-3 rounded-xl transition-all border-2 border-transparent bg-indigo-50 text-indigo-600 active-mode-btn">
                                <div class="flex flex-col items-center gap-1">
                                    <span class="text-2xl">â˜ï¸</span>
                                    <span class="text-xs font-bold">é›²ç«¯é€£çµ</span>
                                </div>
                                <div class="absolute inset-0 border-2 border-indigo-500 rounded-xl opacity-100 transition-opacity"></div>
                            </button>
                            <button onclick="switchInputMode('paste')" id="mode-paste" class="group relative px-6 py-3 rounded-xl transition-all border-2 border-transparent bg-white text-slate-500 hover:bg-slate-50">
                                <div class="flex flex-col items-center gap-1">
                                    <span class="text-2xl">ğŸ“‹</span>
                                    <span class="text-xs font-bold">ç›´æ¥è²¼ä¸Š</span>
                                </div>
                                <div class="absolute inset-0 border-2 border-slate-300 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            </button>
                        </div>
                    </div>

                    <div id="cloud-guide" class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-4 text-white mb-8 shadow-lg transform transition-all hover:scale-[1.01]">
                        <h4 class="font-bold text-lg mb-2 flex items-center gap-2">ğŸ’¡ å¿«é€ŸæŒ‡å¼•</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm opacity-90">
                            <div class="flex items-center gap-2"><span class="bg-white/20 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs">1</span><span>è¤‡è£½ Google è©¦ç®—è¡¨é€£çµ</span></div>
                            <div class="flex items-center gap-2"><span class="bg-white/20 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs">2</span><span>ç¢ºä¿æ¬Šé™è¨­ç‚ºã€ŒçŸ¥é“é€£çµè€…ã€</span></div>
                            <div class="flex items-center gap-2"><span class="bg-white/20 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs">3</span><span>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹åˆ†æ</span></div>
                        </div>
                    </div>

                    <div id="input-cloud-area" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="input-group-card bg-white border-blue-100 hover:border-blue-400">
                            <span class="input-label-badge bg-blue-500 text-white">1. å ±åè¡¨</span>
                            <div class="mt-4 relative">
                                <label class="block text-sm font-bold text-slate-500 mb-2 ml-1">Google Sheet CSV é€£çµ</label>
                                <input type="text" id="url-reg" class="modern-input focus:ring-blue-100 focus:border-blue-500" placeholder="https://docs.google.com/..." onchange="saveLocal()" oninput="validateUrl(this)">
                                <div class="validation-icon text-slate-300">â³</div>
                            </div>
                            <p class="mt-3 text-xs text-blue-600 flex items-center gap-1">ğŸ’¡ åŒ…å« <span class="font-bold">æˆå“¡åç¨±</span> èˆ‡ <span class="font-bold">å¿—é¡˜é¸é …</span> çš„è©¦ç®—è¡¨</p>
                        </div>
                        <div class="input-group-card bg-white border-orange-100 hover:border-orange-400">
                            <span class="input-label-badge bg-furnace-500 text-white">2. æˆ°åŠ›è¡¨</span>
                            <div class="mt-4 relative">
                                <label class="block text-sm font-bold text-slate-500 mb-2 ml-1">Google Sheet CSV é€£çµ</label>
                                <input type="text" id="url-power" class="modern-input focus:ring-orange-100 focus:border-orange-500" placeholder="https://docs.google.com/..." onchange="saveLocal()" oninput="validateUrl(this)">
                                <div class="validation-icon text-slate-300">â³</div>
                            </div>
                            <p class="mt-3 text-xs text-orange-600 flex items-center gap-1">ğŸ’¡ åŒ…å« <span class="font-bold">æˆå“¡ ID</span> èˆ‡ <span class="font-bold">æˆ°åŠ›æ•¸å€¼</span> çš„è©¦ç®—è¡¨</p>
                        </div>
                    </div>

                    <div id="input-paste-area" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <textarea id="csv-reg" class="modern-input h-64" placeholder="è²¼ä¸Šå ±åè¡¨ CSV å…§å®¹..."></textarea>
                        <textarea id="csv-power" class="modern-input h-64" placeholder="è²¼ä¸Šæˆ°åŠ›è¡¨ CSV å…§å®¹..."></textarea>
                    </div>
                    
                    <div id="col-picker" class="hidden mt-8 bg-slate-50 p-6 rounded-xl border border-slate-200 shadow-inner">
                        <h3 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center gap-2"><span>ğŸ”</span> æ¬„ä½ç¢ºèª</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-4 rounded-lg border border-blue-100 shadow-sm">
                                <h4 class="text-sm font-black text-blue-600 mb-3 uppercase tracking-wide">å ±åè¡¨è¨­å®š</h4>
                                <div class="space-y-3">
                                    <div><label class="text-xs font-bold text-slate-500 block mb-1">ç©å®¶åç¨±æ¬„ä½ (*)</label><select id="col-reg-name" class="w-full border-2 rounded-lg p-2 text-sm bg-slate-50"></select></div>
                                    <div><label class="text-xs font-bold text-slate-500 block mb-1">å¿—é¡˜é¸é …æ¬„ä½</label><select id="col-reg-opt" class="w-full border-2 rounded-lg p-2 text-sm bg-blue-50 border-blue-200"></select></div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-orange-100 shadow-sm">
                                <h4 class="text-sm font-black text-orange-600 mb-3 uppercase tracking-wide">æˆ°åŠ›è¡¨è¨­å®š</h4>
                                <div class="space-y-3">
                                    <div><label class="text-xs font-bold text-slate-500 block mb-1">ç©å®¶ ID æ¬„ä½ (*)</label><select id="col-pow-name" class="w-full border-2 rounded-lg p-2 text-sm bg-slate-50"></select></div>
                                    <div><label class="text-xs font-bold text-slate-500 block mb-1">æˆ°åŠ›æ•¸å€¼æ¬„ä½ (*)</label><select id="col-pow-val" class="w-full border-2 rounded-lg p-2 text-sm bg-orange-50 border-orange-200"></select></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="match-check-panel" class="hidden mt-6 bg-amber-50 p-6 rounded-xl border-l-8 border-amber-500 shadow-md">
                        <div class="flex items-start gap-4">
                            <div class="text-3xl">âš ï¸</div>
                            <div class="w-full">
                                <h3 class="font-bold text-amber-800 text-lg">åå–®å°æ‡‰æª¢æŸ¥</h3>
                                <div id="match-check-container" class="space-y-2 max-h-60 overflow-y-auto custom-scroll pr-2 bg-white rounded-lg p-2 border border-amber-200 mt-2"></div>
                                <div class="mt-4 text-right"><button onclick="saveManualMappingsAndRun()" class="bg-amber-600 text-white px-6 py-2 rounded-lg shadow font-bold hover:bg-amber-700 transition-colors">å„²å­˜ä¿®æ­£ä¸¦ç¹¼çºŒ</button></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-10 flex flex-col md:flex-row justify-end gap-4 items-center border-t pt-6">
                        <div id="loading-status" class="text-slate-500 text-sm font-mono hidden flex items-center gap-2"><span class="animate-spin">â†»</span> <span id="loading-text">æº–å‚™ä¸­...</span></div>
                        <div class="flex gap-4 w-full md:w-auto">
                            <button id="btn-pre" onclick="preProcessData()" class="flex-1 md:flex-none group relative px-8 py-3 bg-slate-700 text-white font-bold rounded-xl shadow-md hover:bg-slate-600 transition-all overflow-hidden">
                                <span class="relative z-10 flex items-center justify-center gap-2"><span class="group-hover:-translate-y-1 transition-transform duration-300">ğŸ”</span> è®€å– & æª¢æŸ¥</span>
                            </button>
                            <button id="btn-run" onclick="handleAllocation()" class="hidden flex-1 md:flex-none relative px-10 py-3 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white font-black rounded-xl shadow-lg hover:shadow-2xl hover:scale-105 transition-all duration-300 animate-pulse-slow">
                                <span class="flex items-center justify-center gap-2 text-lg">ğŸš€ å•Ÿå‹•æˆ°ç•¥åˆ†æ</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-dashboard" class="hidden animate-fade-in pb-16">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="stat-card border-l-4 border-slate-800 group">
                        <div class="stat-icon-box bg-slate-100 text-slate-700 group-hover:bg-slate-800 group-hover:text-white transition-colors"><span class="material-symbols-rounded">group</span></div>
                        <div>
                            <div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">Total Units</div>
                            <div class="text-3xl font-black text-slate-800 font-mono" id="stat-n">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card border-l-4 border-furnace-500 group cursor-pointer" onclick="exportToDiscord()">
                        <div class="stat-icon-box bg-orange-100 text-furnace-600 group-hover:bg-furnace-600 group-hover:text-white transition-colors"><span class="material-symbols-rounded">swords</span></div>
                        <div>
                            <div class="text-[10px] uppercase text-orange-400 font-bold tracking-wider">Total Power</div>
                            <div class="text-2xl font-black text-furnace-600 font-mono" id="stat-power">0</div>
                        </div>
                    </div>

                    <div class="stat-card border-l-4 border-red-500 group relative overflow-hidden">
                        <div class="stat-icon-box bg-red-50 text-red-500 group-hover:bg-red-500 group-hover:text-white transition-colors animate-pulse"><span class="material-symbols-rounded">warning</span></div>
                        <div>
                            <div class="text-[10px] uppercase text-red-400 font-bold tracking-wider">Conflicts</div>
                            <div class="text-3xl font-black text-red-600 font-mono" id="stat-conflict">0</div>
                        </div>
                        <button onclick="autoResolveConflicts()" class="absolute right-2 top-1/2 -translate-y-1/2 bg-red-100 hover:bg-red-200 text-red-700 text-xs px-3 py-1.5 rounded-full font-bold shadow opacity-0 group-hover:opacity-100 transition-opacity" title="ã€è¡çªè‡ªå‹•ä¿®å¾©ã€‘&#10;å˜—è©¦è§£æ±ºã€ŒåŒå®¶æ—æ’æœŸã€æˆ–ã€ŒåŒéšŠã€å•é¡Œã€‚&#10;ç³»çµ±æœƒå˜—è©¦èˆ‡å…¶ä»–éšŠä¼æˆå“¡äº¤æ›ä½ç½®ã€‚&#10;å„ªå…ˆå°‹æ‰¾æˆ°åŠ›ç›¸è¿‘ä¸”äº¤æ›å¾Œä¸æœƒç”¢ç”Ÿæ–°è¡çªçš„å°è±¡ã€‚">
                            âš¡ Auto Fix
                        </button>
                    </div>

                    <div class="stat-card border-l-4 border-amber-400 group relative overflow-hidden">
                        <div class="stat-icon-box bg-amber-50 text-amber-500 group-hover:bg-amber-400 group-hover:text-white transition-colors"><span class="material-symbols-rounded">schedule_send</span></div>
                        <div>
                            <div class="text-[10px] uppercase text-amber-400 font-bold tracking-wider">Pref. Mismatch</div>
                            <div class="text-3xl font-black text-amber-500 font-mono" id="stat-pref-mismatch">0</div>
                        </div>
                        <button onclick="autoCorrectPreferences()" class="absolute right-2 top-1/2 -translate-y-1/2 bg-amber-100 hover:bg-amber-200 text-amber-700 text-xs px-3 py-1.5 rounded-full font-bold shadow opacity-0 group-hover:opacity-100 transition-opacity" title="ã€å¿—é¡˜è‡ªå‹•æ ¡æ­£ã€‘&#10;å°‡ã€Œå¿—é¡˜ä¸ç¬¦ã€çš„æˆå“¡ç§»å‹•åˆ°æ­£ç¢ºæ™‚æ®µã€‚&#10;åƒ…åœ¨äº¤æ›å®‰å…¨ï¼ˆç„¡è¡çªï¼‰æ™‚åŸ·è¡Œã€‚">
                            âš¡ Auto Fix
                        </button>
                    </div>

                    <div class="stat-card border-l-4 border-amber-500 group cursor-pointer hover:bg-amber-50" onclick="switchTab('settings')">
                        <div class="stat-icon-box bg-amber-50 text-amber-500"><span class="material-symbols-rounded">link_off</span></div>
                        <div>
                            <div class="text-[10px] uppercase text-amber-400 font-bold tracking-wider">Unknown ID</div>
                            <div class="text-3xl font-black text-amber-600 font-mono" id="stat-unknown">0</div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-3 rounded-2xl mb-4 flex flex-col md:flex-row gap-4 items-center justify-between shadow-sm sticky top-16 z-30">
    <div class="flex items-center gap-2 overflow-x-auto w-full md:w-auto pb-1 md:pb-0 scrollbar-hide">
        
        <div class="bg-white border border-slate-200 px-3 py-2 rounded-xl flex items-center gap-2 shadow-sm mr-2">
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="toggle-pref" class="sr-only peer" onchange="togglePrefMode()">
                <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                <span class="ml-2 text-xs font-bold text-slate-600 select-none">éµå¾ªå¿—é¡˜</span>
            </label>
        </div>

        <div class="flex bg-slate-200/80 p-1 rounded-xl gap-1 shrink-0">
            <button onclick="runTeamLogic('snake')" class="px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-white hover:shadow-sm transition-all text-slate-600"><span class="material-symbols-rounded text-sm">gesture</span> Så‹</button>
            <button onclick="runTeamLogic('m_type')" class="px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-white hover:shadow-sm transition-all text-slate-600"><span class="material-symbols-rounded text-sm">bar_chart_4_bars</span> Må‹</button>
            <button onclick="runTeamLogic('descending')" class="px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-white hover:shadow-sm transition-all text-slate-600"><span class="material-symbols-rounded text-sm">stairs</span> éšæ¢¯</button>
        </div>

        <div class="h-8 w-px bg-slate-300 mx-1"></div>
        
       <button onclick="autoCorrectPreferences()" class="shrink-0 px-3 py-2 bg-indigo-50 text-indigo-600 border border-indigo-100 rounded-xl text-xs font-bold hover:bg-indigo-100 flex items-center gap-1" title="ã€å¿—é¡˜æ ¡æ­£åŠŸèƒ½ã€‘&#10;å˜—è©¦å°‡æˆå“¡ç§»å‹•åˆ°ä»–å€‘æœŸæœ›çš„æ™‚æ®µã€‚&#10;ç³»çµ±æœƒå°‹æ‰¾ã€Œæƒ³å»å°æ–¹æ™‚æ®µã€æˆ–ã€Œæ™‚é–“çš†å¯ã€çš„æˆå“¡é€²è¡Œäº¤æ›ã€‚&#10;æ³¨æ„ï¼šè‹¥äº¤æ›æœƒå°è‡´å®¶æ—è¡çªï¼Œç³»çµ±å°‡ä¸æœƒåŸ·è¡Œè©²äº¤æ›ã€‚">
    <span class="material-symbols-rounded text-sm">published_with_changes</span> æ ¡æ­£
</button>
        <button onclick="toggleTeamModal()" class="shrink-0 px-3 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold hover:bg-slate-700 shadow flex items-center gap-1">
            <span class="material-symbols-rounded text-sm">settings</span> è¨­å®š
        </button>
    </div>

    <div class="flex gap-2 w-full md:w-auto">
        <div class="relative w-full md:w-48">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 material-symbols-rounded text-sm">search</span>
            <input type="text" placeholder="æœå°‹..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all" oninput="filterMembers(this.value)">
        </div>
        <button onclick="copyMemberList()" class="shrink-0 px-4 py-2 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-xl text-xs font-bold flex items-center gap-1"><span class="material-symbols-rounded text-sm">content_copy</span> è¤‡è£½</button>
    </div>
</div>

                <div id="pop-alert" class="hidden bg-red-50 border-l-4 border-red-500 text-red-800 p-4 rounded-xl shadow-md text-sm font-bold flex items-center gap-3 mb-4 animate-slide-up"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6" id="dashboard-container">
                    </div>

                <div class="mt-4 glass-panel p-4 rounded-2xl flex flex-col md:flex-row gap-4 items-center">
                    <div class="w-full md:w-1/3 flex flex-col gap-6">
    <div>
        <h4 class="font-bold text-slate-700 text-sm mb-2">ğŸ° è»åœ˜ç¸½æˆ°åŠ›æ¯”è¼ƒ</h4>
        <div class="h-32 w-full"><canvas id="powerChart"></canvas></div>
    </div>

    <div class="border-t border-slate-200 pt-4">
        <div class="flex justify-between items-center mb-2">
            <h4 class="font-bold text-slate-700 text-sm">ğŸ“Š å…¨å“¡æˆ°åŠ›å€é–“åˆ†ä½ˆ</h4>
            <span id="global-m-ratio" class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded">M: 0%</span>
        </div>
        <div class="h-32 w-full"><canvas id="globalDistChart"></canvas></div>
    </div>
</div>
                    <div class="w-full md:w-2/3">
                         <div id="absent-panel" class="hidden bg-slate-50 border border-slate-200 rounded-xl p-3">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-slate-600 text-xs flex items-center gap-1"><span class="material-symbols-rounded text-sm">block</span> ä¸åƒåŠ åå–® (<span id="absent-count">0</span>)</h4>
                            </div>
                            <div id="absent-list" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto custom-scroll text-xs"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-tactics" class="hidden space-y-6">
                <div class="glass-panel p-6 rounded-2xl bg-white">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
                        <div><h2 class="text-2xl font-black text-slate-800">âš”ï¸ æˆ°è¡“ä»»å‹™ç·¨çµ„</h2></div>
                        <div class="flex gap-4 items-center bg-slate-50 p-2 rounded-lg">
                            <select id="tactics-team-select" class="p-2 border border-slate-300 rounded font-bold text-slate-700" onchange="renderTacticsBoard()"></select>
                            <button onclick="autoDistributeMissions()" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold shadow">âš¡ Så‹å¹³è¡¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-8" id="tactics-container"></div>
                    <div class="border-t border-slate-200 pt-6 mt-4">
    <div class="flex justify-between items-center mb-3">
        <h3 class="font-bold text-slate-700 flex items-center gap-2">
            <span class="material-symbols-rounded text-slate-500">terminal</span> 
            æˆ°è¡“æŒ‡ä»¤é è¦½
        </h3>
        <button onclick="copyMissionText()" class="bg-slate-800 hover:bg-slate-900 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-lg shadow-slate-300 transition-all active:scale-95 flex items-center gap-2">
            <span class="material-symbols-rounded text-sm">content_copy</span> 
            ä¸€éµè¤‡è£½
        </button>
    </div>
    
    <div class="relative group">
        <textarea id="mission-text" 
            class="w-full h-80 bg-slate-900 text-green-400 font-mono text-xs md:text-sm p-5 rounded-2xl shadow-inner outline-none focus:ring-2 focus:ring-indigo-500 transition-all custom-scroll resize-y border border-slate-700 leading-relaxed" 
            readonly 
            placeholder="ç­‰å¾…ç”Ÿæˆæˆ°è¡“æŒ‡ä»¤..."></textarea>
            
        <div class="absolute top-3 right-4 text-[10px] text-slate-600 font-mono select-none border border-slate-700 px-2 py-0.5 rounded">READ ONLY</div>
    </div>

    <p class="text-xs text-slate-400 mt-2 text-right flex justify-end items-center gap-1">
        ğŸ’¡ æç¤ºï¼šæ­¤æ ¼å¼å·²å„ªåŒ–ï¼Œå¯ç›´æ¥è²¼ä¸Š Line è¨˜äº‹æœ¬æˆ– Discord
    </p>
</div>
                </div>
            </section>
            <section id="page-attendance" class="hidden space-y-6">
                <div class="glass-panel p-6 rounded-2xl bg-white">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <div><h2 class="text-2xl font-black text-slate-800">ğŸ“‹ è³½å¾Œé»åç³»çµ±</h2></div>
                        <div class="flex gap-2">
                            <button onclick="initAttendance()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow font-bold">ğŸ†• é–‹å§‹æ–°é»å</button>
                            <button onclick="saveAttendance()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded shadow font-bold">ğŸ’¾ å„²å­˜è¨˜éŒ„</button>
                        </div>
                    </div>
                    <div id="attendance-active-area" class="hidden space-y-6">
                        <div class="flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <span class="font-bold text-blue-800" id="att-date-display"></span>
                            <div class="flex gap-2"><button onclick="markAllPresent()" class="text-xs bg-white border border-blue-200 px-2 py-1 rounded text-blue-600 hover:bg-blue-100 font-bold">å…¨éƒ¨å‡ºå¸­</button></div>
                        </div>
                        <div id="attendance-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
                        <div class="lg:col-span-2"><h3 class="font-bold text-slate-700 mb-3">ğŸ•’ æ­·å²è¨˜éŒ„</h3><div id="attendance-history-list" class="space-y-2 max-h-60 overflow-y-auto custom-scroll"></div></div>
                        <div><h3 class="font-bold text-red-600 mb-3 flex items-center gap-2">âš ï¸ ç¼ºå¸­çµ±è¨ˆè­¦å ±</h3><div id="attendance-alert-list" class="space-y-2 max-h-60 overflow-y-auto custom-scroll bg-red-50 p-3 rounded-lg border border-red-100"></div></div>
                    </div>
                </div>
            </section>
            <section id="page-history" class="hidden space-y-6">
                <div class="glass-panel p-6 rounded-2xl bg-white">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl font-black text-slate-800">ğŸ’¾ å­˜æª”èˆ‡å‚™ä»½</h2>
                        <div class="flex gap-2">
                            <button onclick="exportConfig()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded text-sm font-bold">ğŸ“¤ åŒ¯å‡º JSON</button>
                            <label class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded text-sm font-bold cursor-pointer">ğŸ“¥ åŒ¯å…¥ JSON <input type="file" class="hidden" onchange="importConfig(this)"></label>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-slate-50 p-4 rounded-lg border"><h3 class="font-bold mb-2">å„²å­˜ç•¶å‰é…ç½®</h3><input type="text" id="save-name" placeholder="è¼¸å…¥å­˜æª”åç¨±" class="w-full border p-2 rounded mb-2"><button onclick="saveConfiguration()" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">ğŸ’¾ ç«‹å³å„²å­˜</button></div>
                        <div class="col-span-2"><h3 class="font-bold mb-2">æ­·å²ç´€éŒ„</h3><div id="history-list" class="space-y-2 max-h-96 overflow-y-auto custom-scroll border rounded bg-white p-2"></div></div>
                    </div>
                </div>
            </section>
            <section id="page-settings" class="hidden space-y-6">
                <div id="linker-panel" class="glass-panel p-6 rounded-2xl bg-white border-l-4 border-amber-500 hidden mb-6">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-black text-amber-800 flex items-center gap-2">âš ï¸ æˆ°åŠ›è³‡æ–™æ ¡æº–</h3><div class="flex gap-2"><button onclick="clearManualMappings()" class="px-4 py-2 bg-red-100 text-red-600 rounded font-bold text-sm shadow hover:bg-red-200">ğŸ—‘ï¸ æ¸…é™¤ç´€éŒ„</button><button onclick="applyManualMappings()" class="px-4 py-2 bg-amber-600 text-white rounded font-bold text-sm shadow hover:bg-amber-700">å„²å­˜ä¿®æ­£</button></div></div>
                    <div id="linker-container" class="space-y-2 max-h-64 overflow-y-auto custom-scroll bg-amber-50 p-4 rounded-lg"></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-panel p-6 rounded-2xl bg-white"><h3 class="text-lg font-black text-slate-800 mb-4">ğŸ° è»åœ˜ç®¡ç†</h3><div class="h-64 overflow-y-auto custom-scroll border rounded"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-500"><tr><th class="p-2">åç¨±</th><th class="p-2">æ™‚æ®µ</th><th class="p-2">ç‹€æ…‹</th></tr></thead><tbody id="team-list-body"></tbody></table></div></div>
                    <div class="glass-panel p-6 rounded-2xl bg-white"><h3 class="text-lg font-black text-slate-800 mb-4">ğŸ”— å¸³è™Ÿç¶å®š</h3><div class="flex gap-2 mb-4"><input type="text" id="bind-main" placeholder="ä¸»è™Ÿ" class="border p-2 rounded w-1/2 text-sm"><input type="text" id="bind-alt" placeholder="å°è™Ÿ" class="border p-2 rounded w-1/2 text-sm"><button onclick="addBinding()" class="bg-blue-600 text-white px-3 rounded font-bold text-sm">æ–°å¢</button></div><div class="h-64 overflow-y-auto custom-scroll border rounded"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-500"><tr><th class="p-2">ä¸»è™Ÿ</th><th class="p-2">å°è™Ÿé—œéµå­—</th><th class="p-2">æ“ä½œ</th></tr></thead><tbody id="bind-list-body"></tbody></table></div></div>
                </div>
            </section>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-3 flex justify-between items-center md:hidden z-40 shadow-lg">
        <span class="text-xs font-bold text-slate-600">v68.1</span>
        <div class="flex gap-2">
            <button onclick="saveConfiguration()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold">å„²å­˜</button>
            <button onclick="copyMemberList()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">ğŸ“‹ è¤‡è£½</button>
        </div>
    </div>

   <script>
        // --- å…¨åŸŸè®Šæ•¸è¨­å®š ---
        const DEFAULT_TEAMS = [
            {id:'jQt1',name:'jQtè»åœ˜ä¸€',time:'22:00',active:true,priority:0},
            {id:'aQt1',name:'aQtè»åœ˜ä¸€',time:'22:00',active:true,priority:1},
            {id:'jQt2',name:'jQtè»åœ˜äºŒ',time:'20:00',active:true,priority:2},
            {id:'aQt2',name:'aQtè»åœ˜äºŒ',time:'20:00',active:true,priority:3}
        ];
        
        // ç¶å®šè³‡æ–™ (ä¸»è™Ÿ/å°è™Ÿ)
        const DEFAULT_ALTS = [
            {main:"ä¸»æµå…”",alt:"ç›Ÿæµªå…”"},{main:"ä¸»æµå…”",alt:"å…”ä»”å­"},{main:"å†¬ä¾†å†¬å¾€",alt:"å°å†¬å†¬"},
            {main:"åŠ¼å‰æ’ˆ",alt:"è—è‰²åŠ¼å‰æ’ˆATM"},{main:"Masaorange",alt:"å°é¦¬æ®º"},{main:"Masaorange",alt:"å°é¦¬å“¥"},
            {main:"å°èèŸ»",alt:"å°å°èèŸ»"},{main:"å¿«æ¨‚æ°¸ä¼´",alt:"HappyHappy"},{main:"ä¸€å¿µé—œå±±",alt:"ä¸€å¿µè§€å±±"},
            {main:"PekingDuck",alt:"åŒ—äº¬çƒ¤é¸­"},{main:"YI9908zh",alt:"Yi2"},{main:"å‘¨æ˜Ÿæ˜Ÿ",alt:"éº»éº»è±†è±†~"},
            {main:"éŒ¢åŒ…åŒ…",alt:"éŒ¢å¤šå¤š"},{main:"Rueiii",alt:"å°æ¢…å¹¾"}
        ];

        const MULTI_CONTROLLERS = ["æŸ’æŸ’", "jackç©ç©å§", "queenie_9z"];
        const MISSION_GROUPS = [
            {id:1, color:'red', name:'ç¬¬ 1 çµ„', target:'æ–¹ä½ï¼š10 é»é˜æ–¹å‘\nç›®æ¨™ï¼šè’¸æ±½é‹çˆã€1 è™Ÿæ­¦å™¨è©¦é©—å ´ã€å‚­å…µç«™ã€ä¸­é–“æ“šé»'},
            {id:2, color:'orange', name:'ç¬¬ 2 çµ„', target:'æ–¹ä½ï¼š5 é»é˜æ–¹å‘\nç›®æ¨™ï¼šä¸­è½‰ç«™ã€2 è™Ÿæ­¦å™¨è©¦é©—å ´ã€è»ç«åº«ã€ä¸­é–“æ“šé»'},
            {id:3, color:'blue', name:'ç¬¬ 3 çµ„', target:'æ–¹ä½ï¼š2 é»é˜æ–¹å‘\nç›®æ¨™ï¼š2 è™Ÿæ­¦å™¨ç¶­ä¿®å» ã€4 è™Ÿæ­¦å™¨ç¶­ä¿®å» ã€è»ç«åº«ã€ä¸­é–“æ“šé»'},
            {id:4, color:'green', name:'ç¬¬ 4 çµ„', target:'æ–¹ä½ï¼š7 é»é˜æ–¹å‘\nç›®æ¨™ï¼š1 è™Ÿæ­¦å™¨ç¶­ä¿®å» ã€3 è™Ÿæ­¦å™¨ç¶­ä¿®å» ã€è»ç«åº«ã€ä¸­é–“æ“šé»'}
        ];
        const ABSENT_KEYWORDS = ['ä¸å…‹', 'ç„¡æ³•', 'è«‹å‡', 'ä¸åƒåŠ ', 'æœªåƒåŠ ', 'æ²’ç©º', 'pass', 'no', 'ä¸ä¾†', 'ä¸åƒæˆ°'];

        let appState = { 
            players:[], absentPlayers:[], unknownPlayers:[], availablePowerNames:[], 
            manualMappings:{}, teams:[], alts:[], conflictMap:{}, 
            rawRegData:[], rawPowerData:[], currentTacticalTeamId:'', 
            manualTeamCount:null, lastLogicMode: 'snake', savedConfigs: [], 
            attendanceHistory: [], currentAttendance: {}, isAbsentExpanded: true, 
            prioritizePreferences: false 
        };
        let currentMode='cloud'; 
        let chartInstance = null; 
        let teamCharts = {}; 

        // --- æ ¸å¿ƒå·¥å…·å‡½æ•¸ ---
        function setText(id,t){ const e=document.getElementById(id); if(e)e.innerText=t; }
        function formatSmart(n) { if (n >= 1000) return Math.round(n/1000).toLocaleString() + 'k'; return Math.round(n).toLocaleString(); }
        
        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const bg = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-green-600' : 'bg-slate-800');
            el.className = `toast ${bg} mb-2 px-4 py-2 rounded text-white shadow-lg transition-all transform translate-y-2`; 
            el.innerText = msg; 
            container.appendChild(el);
            setTimeout(() => el.classList.remove('translate-y-2'), 10);
            setTimeout(() => { el.classList.add('opacity-0'); setTimeout(() => el.remove(), 300); }, 3000);
        }

        function validateUrl(input) { 
            const icon = input.parentElement.querySelector('.validation-icon'); 
            const val = input.value.trim(); 
            if (!val) { 
                icon.innerText = 'â³'; 
                icon.className = 'validation-icon text-slate-300'; 
                return; 
            } 
            // å¯¬é¬†æª¢æŸ¥ï¼Œé¿å…èª¤åˆ¤
            if (val.includes('docs.google.com') || val.endsWith('.csv') || val.startsWith('http')) { 
                icon.innerText = 'âœ“'; 
                icon.className = 'validation-icon text-green-500'; 
            } else { 
                icon.innerText = 'âš ï¸'; 
                icon.className = 'validation-icon text-amber-500 animate-pulse'; 
            } 
        }

        function updateLoadingStatus(text, show) { 
            const el = document.getElementById('loading-status'); 
            const txt = document.getElementById('loading-text'); 
            if(show) { el.classList.remove('hidden'); txt.innerText = text; } 
            else { el.classList.add('hidden'); } 
        }

        // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ ---
        document.addEventListener('DOMContentLoaded', ()=>{
            const sm = localStorage.getItem('jQt_mappings'); 
            const sh = localStorage.getItem('jQt_history'); 
            const att = localStorage.getItem('jQt_attendance');
            
            appState.teams = JSON.parse(JSON.stringify(DEFAULT_TEAMS)); 
            appState.alts = JSON.parse(JSON.stringify(DEFAULT_ALTS));
            appState.manualMappings = sm ? JSON.parse(sm) : {}; 
            appState.savedConfigs = sh ? JSON.parse(sh) : []; 
            appState.attendanceHistory = att ? JSON.parse(att) : [];
            
            const r=localStorage.getItem('jQt_url_reg');
            const p=localStorage.getItem('jQt_url_power');
            
            if(r) { 
                const el = document.getElementById('url-reg');
                el.value=r; 
                validateUrl(el); 
            }
            if(p) { 
                const el = document.getElementById('url-power');
                el.value=p; 
                validateUrl(el); 
            }
            
            renderSettings(); 
            renderHistoryList(); 
            renderAttendanceHistory(); 
            switchTab('input');
        });

        // --- å°èˆªåˆ‡æ› ---
        function switchTab(page){
            document.querySelectorAll('section').forEach(s=>s.classList.add('hidden')); 
            const target = document.getElementById(`page-${page}`);
            if(target) target.classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); 
            const btn = document.getElementById(`nav-${page}`);
            if(btn) btn.classList.add('active');
            
            if(page==='tactics') initTactics(); 
            if(page==='settings') renderSettings(); 
            if(page==='dashboard') renderDashboard();
        }

        function switchInputMode(m){
            currentMode=m; 
            document.querySelectorAll('#mode-cloud, #mode-paste').forEach(b => { 
                b.classList.remove('active-mode-btn', 'bg-indigo-50', 'text-indigo-600'); 
                b.classList.add('bg-white', 'text-slate-500'); 
                b.querySelector('.absolute').classList.remove('opacity-100'); 
                b.querySelector('.absolute').classList.add('opacity-0'); 
            });
            const btn = document.getElementById(`mode-${m}`);
            if(btn) { 
                btn.classList.add('active-mode-btn', 'bg-indigo-50', 'text-indigo-600'); 
                btn.classList.remove('bg-white', 'text-slate-500'); 
                btn.querySelector('.absolute').classList.add('opacity-100'); 
                btn.querySelector('.absolute').classList.remove('opacity-0'); 
            }
            document.getElementById('input-cloud-area').classList.toggle('hidden', m!=='cloud'); 
            document.getElementById('input-paste-area').classList.toggle('hidden', m!=='paste'); 
            const guide = document.getElementById('cloud-guide');
            if(guide) guide.classList.toggle('hidden', m!=='cloud');
        }

        function toggleDarkMode() { document.body.classList.toggle('dark'); }

        // --- è³‡æ–™è™•ç†æ ¸å¿ƒ (ä¿®å¾©ç‰ˆ) ---
        function saveLocal(){ 
            localStorage.setItem('jQt_url_reg', document.getElementById('url-reg').value); 
            localStorage.setItem('jQt_url_power', document.getElementById('url-power').value); 
            localStorage.setItem('jQt_mappings', JSON.stringify(appState.manualMappings)); 
        }

        async function fetchWithFallback(url) {
            // 1. è‡ªå‹•å„ªåŒ– Google Sheet é€£çµ
            // å¦‚æœä½¿ç”¨è€…è²¼çš„æ˜¯ä¸€èˆ¬ç·¨è¼¯é€£çµï¼Œå˜—è©¦è½‰ç‚ºåŒ¯å‡ºé€£çµ
            if (url.includes('docs.google.com') && url.includes('/edit')) {
                url = url.replace(/\/edit.*$/, '/export?format=csv');
            } else if (url.includes('/pubhtml')) {
                url = url.replace(/\/pubhtml.*/, '/pub?output=csv');
            }

            // å®šç¾©é€£ç·šå˜—è©¦é †åº
            // ã€é‡è¦ä¿®æ”¹ã€‘å°‡ "ç›´é€£ (Direct)" æ”¾åœ¨ç¬¬ä¸€é †ä½
            // å¦‚æœä½ æœ‰åšã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€ï¼Œç›´é€£æ˜¯æœ€å¿«ä¸”çµ•å°ä¸æœƒæ¼è³‡æ–™çš„
            const steps = [
                { url: url, name: "ç›´é€£å˜—è©¦ (Google Publish)" }, 
                { url: `https://corsproxy.io/?${encodeURIComponent(url)}`, name: "é«˜é€Ÿä»£ç† (CorsProxy)" },
                { url: `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, name: "å‚™ç”¨ä»£ç† (AllOrigins)" },
                { url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, name: "å¼·åŠ›ä»£ç† (CodeTabs)" }
            ];

            const fetchWithTimeout = async (resource, options = {}) => {
                const { timeout = 8000 } = options; // å»¶é•·é€¾æ™‚åˆ° 8 ç§’ï¼Œé¿å… GitHub ç¶²è·¯æ…¢å°è‡´æ¼æŠ“
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try {
                    const response = await fetch(resource, { ...options, signal: controller.signal });
                    clearTimeout(id);
                    return response;
                } catch (error) {
                    clearTimeout(id);
                    throw error;
                }
            };

            for (const s of steps) {
                try {
                    console.log(`[é€£ç·šå˜—è©¦] ${s.name}...`);
                    const r = await fetchWithTimeout(s.url);
                    
                    if (r.ok) {
                        const t = await r.text();
                        // æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§ï¼šå¦‚æœæ˜¯ HTML éŒ¯èª¤é é¢ï¼Œè¦–ç‚ºå¤±æ•—
                        if (t.trim().startsWith('<!DOCTYPE') || t.trim().startsWith('<html') || t.includes('Moved Temporarily')) {
                            console.warn(`[é€£ç·šè­¦å‘Š] ${s.name} å›å‚³äº† HTML æˆ–éŒ¯èª¤é é¢ï¼Œè·³éã€‚`);
                            continue;
                        }
                        // æª¢æŸ¥æ˜¯å¦å¤ªçŸ­ (é˜²æ­¢ Proxy æˆªæ–·è³‡æ–™)
                        if (t.length < 50) {
                             console.warn(`[é€£ç·šè­¦å‘Š] ${s.name} å›å‚³è³‡æ–™éçŸ­ï¼Œå¯èƒ½è¢«æˆªæ–·ï¼Œè·³éã€‚`);
                             continue;
                        }
                        return t; // æˆåŠŸæ‹¿åˆ°è³‡æ–™
                    }
                } catch (e) {
                    console.warn(`[é€£ç·šå¤±æ•—] ${s.name}:`, e.name);
                }
            }

            throw new Error("ç„¡æ³•è®€å–è³‡æ–™ã€‚å»ºè­°ï¼š\n1. Google è©¦ç®—è¡¨è«‹ä½¿ç”¨ã€Œæª”æ¡ˆ>å…±ç”¨>ç™¼å¸ƒåˆ°ç¶²è·¯ã€çš„é€£çµã€‚\n2. æˆ–æ”¹ç”¨ã€Œç›´æ¥è²¼ä¸Šã€æ¨¡å¼ã€‚");
        }

        function parseCSV(text) {
            if (!text) return [];
            text = text.replace(/^\uFEFF/, ''); 
            const rows = [];
            let row = [];
            let val = '';
            let inQuote = false;
            
            for (let i = 0; i < text.length; i++) {
                let c = text[i];
                let n = text[i+1];
                
                if (c === '"') {
                    if (inQuote && n === '"') { val += '"'; i++; } 
                    else { inQuote = !inQuote; }
                } else if (c === ',' && !inQuote) {
                    row.push(val.trim()); val = '';
                } else if ((c === '\r' || c === '\n') && !inQuote) {
                    if(c === '\r' && n === '\n') i++; 
                    row.push(val.trim());
                    if(row.length > 0 && (row.length > 1 || row[0] !== '')) rows.push(row);
                    row = []; val = '';
                } else {
                    val += c;
                }
            }
            if (val || row.length) { 
                row.push(val.trim()); 
                if(row.length > 0) rows.push(row); 
            }
            return rows;
        }

        function normalizeName(n) { 
            if(!n) return ""; 
            // 1. ç§»é™¤ Ræ¨™ç±¤èˆ‡æ‹¬è™Ÿæ¨™ç±¤
            let clean = n.replace(/\[.*?\]/g, '')
                    .replace(/\(R[0-9]\)/gi, '')
                    .replace(/R[0-9]\s/gi, '')
                    .replace(/[\u200B-\u200D\uFEFF]/g, '');
            
            // 2. æ¨™æº–åŒ–ï¼šè½‰å°å¯«ï¼Œä½†ä¿ç•™ã€Œåº•ç·šã€èˆ‡ã€Œé€£å­—è™Ÿã€
            // ä¿®æ­£æ­£å‰‡ï¼šå…è¨± ä¸­æ–‡ã€è‹±æ–‡ã€æ•¸å­—ã€åº•ç·š _ã€é€£å­—è™Ÿ -
            let strict = clean.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_\-]/g, '').toLowerCase().trim(); 
            
            // å¦‚æœè™•ç†å®Œè®Šç©ºå­—ä¸²(ç´”ç¬¦è™Ÿ)ï¼Œå‰‡å›å‚³åŸå§‹ä¹¾æ·¨å…§å®¹ï¼Œå¦å‰‡å›å‚³æ¨™æº–åŒ–å…§å®¹
            return strict.length > 0 ? strict : clean.trim().toLowerCase(); 
        }

        function getFamilyId(name) { 
            const cleanName = normalizeName(name); 
            for(const pair of appState.alts) { 
                const main = normalizeName(pair.main), alt = normalizeName(pair.alt); 
                if(cleanName.includes(alt) || alt.includes(cleanName)) return main; 
                if(cleanName.includes(main) || main.includes(cleanName)) return main; 
            } 
            return cleanName; 
        }

        // --- ä¸‹æ‹‰é¸å–®è™•ç† ---
        function populatePickers(d, id1, id2=null){ 
            const h = d[0] || []; 
            if(h.length === 0) return;
            const mk = (i,n) => `<option value="${i}">[${i}] ${n || 'æœªå‘½å'}</option>`; 
            const processSelect = (id, keywords) => {
                const el = document.getElementById(id);
                if(!el) return;
                el.innerHTML = h.map((x,i) => mk(i,x)).join('');
                let found = -1;
                h.forEach((x, i) => { 
                    const t = String(x).toLowerCase(); 
                    if(keywords.some(k => t.includes(k))) found = i; 
                });
                if(found > -1) el.value = found;
            };
            if(id1.includes('reg')) { processSelect(id1, ['name', 'åç¨±', 'id', 'æš±ç¨±', 'åå­—']); } else { processSelect(id1, ['name', 'åç¨±', 'id']); }
            if(id2) {
                if(id2.includes('opt')) processSelect(id2, ['option', 'é¸é …', 'æ™‚é–“', 'æ„é¡˜', 'åƒåŠ ']);
                if(id2.includes('val')) processSelect(id2, ['power', 'æˆ°åŠ›', 'åˆ†æ•¸']);
            }
        }

        // --- ä¸»è³‡æ–™è®€å–æµç¨‹ (ä¿®å¾©ç‰ˆ) ---
        async function preProcessData(){ 
            const btn = document.getElementById('btn-pre'); 
            if(btn) btn.disabled = true; 
            updateLoadingStatus('é€£æ¥ä¸­...', true); 
            
            try { 
                let r='', p=''; 
                if(currentMode === 'paste'){ 
                    r = document.getElementById('csv-reg').value; 
                    p = document.getElementById('csv-power').value; 
                    if (!r.trim() || !p.trim()) throw new Error("è«‹è²¼ä¸Š CSV è³‡æ–™");
                } else { 
                    const ur = document.getElementById('url-reg').value, up = document.getElementById('url-power').value; 
                    if(!ur || !up) throw new Error("è«‹è¼¸å…¥ Google Sheet é€£çµ"); 
                    [r,p] = await Promise.all([fetchWithFallback(ur), fetchWithFallback(up)]); 
                } 
                
                updateLoadingStatus('è§£æè³‡æ–™...', true); 
                appState.rawRegData = parseCSV(r); 
                appState.rawPowerData = parseCSV(p); 
                
                if(!appState.rawRegData.length) throw new Error("è®€å–å¤±æ•—ï¼šå ±åè¡¨ç‚ºç©º");
                if(!appState.rawPowerData.length) throw new Error("è®€å–å¤±æ•—ï¼šæˆ°åŠ›è¡¨ç‚ºç©º");
                
                populatePickers(appState.rawRegData, 'col-reg-name', 'col-reg-opt'); 
                populatePickers(appState.rawPowerData, 'col-pow-name', 'col-pow-val'); 
                
                document.getElementById('col-picker').classList.remove('hidden'); 
                updateLoadingStatus('é©—è­‰åå–®...', true); 
                
                // ç­‰å¾… UI åˆ·æ–°
                await new Promise(res => setTimeout(res, 100));
                
                verifyNames(); 
                showToast('è³‡æ–™è®€å–æˆåŠŸï¼', 'success'); 
            } catch(e){ 
                console.error(e);
                showToast("éŒ¯èª¤: " + e.message, 'error'); 
            } finally {
                if(btn) btn.disabled = false; 
                updateLoadingStatus('', false); 
            }
        }

        // --- åå–®é©—è­‰èˆ‡åˆ†é… ---
        function verifyNames() { 
            const ri = parseInt(document.getElementById('col-reg-name').value); 
            const ni = parseInt(document.getElementById('col-pow-name').value); 
            
            if(isNaN(ri) || isNaN(ni)) { showToast("éŒ¯èª¤ï¼šç„¡æ³•è­˜åˆ¥æ¬„ä½ç´¢å¼•", "error"); return; }
            
            let powerNames = [], powerMap = {}; 
            for(let i=1; i<appState.rawPowerData.length; i++){ 
                const r = appState.rawPowerData[i]; 
                if(!r[ni]) continue; 
                const raw = r[ni]; 
                const clean = normalizeName(raw); 
                if(clean) { powerNames.push(raw); powerMap[clean] = raw; } 
            } 
            appState.availablePowerNames = powerNames; 
            
            if(powerNames.length === 0) { showToast("è­¦å‘Šï¼šæˆ°åŠ›è¡¨ä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆåå­—", "error"); return; }
            
            let unmatched = [], matchedCount = 0;
            const optIdx = parseInt(document.getElementById('col-reg-opt').value);

            for(let i=1; i<appState.rawRegData.length; i++){ 
                const r = appState.rawRegData[i], name = r[ri]; 
                if(!name) continue; 
                
                const opt = r[optIdx] || ''; 
                if(ABSENT_KEYWORDS.some(k => String(opt).replace(/\s+/g, '').toLowerCase().includes(k))) continue; 
                
                if(appState.manualMappings[name]) { matchedCount++; continue; } 
                
                const clean = normalizeName(name); 
                if(powerMap[clean]) { matchedCount++; continue; } 
                
                const fuzzy = powerNames.find(p => normalizeName(p).includes(clean) || clean.includes(normalizeName(p))); 
                unmatched.push({ orig: name, guess: fuzzy || "" }); 
            } 
            
            const panel = document.getElementById('match-check-panel');
            const container = document.getElementById('match-check-container');
            const btnRun = document.getElementById('btn-run'); 
            
            if(unmatched.length > 0) { 
                panel.classList.remove('hidden'); 
                btnRun.classList.add('hidden'); 
                container.innerHTML = ''; 
                const sortedOpts = [...powerNames].sort(); 
                unmatched.forEach(u => { 
                    let optsHtml = `<option value="">-- è«‹é¸æ“‡ --</option>`; 
                    optsHtml += sortedOpts.map(p => `<option value="${p}" ${p === u.guess ? 'selected' : ''}>${p}</option>`).join('');
                    container.innerHTML += `<div class="flex items-center gap-2 border-b pb-1 mb-1"><span class="w-1/3 text-sm font-bold text-slate-700 truncate" title="${u.orig}">${u.orig}</span><span class="text-slate-400">âœ</span><select id="fix-${u.orig}" class="flex-1 text-sm border rounded p-1 bg-white focus:ring-2 ring-indigo-500">${optsHtml}</select></div>`; 
                }); 
                showToast(`æœ‰ ${unmatched.length} ä½æˆå“¡åç¨±ä¸ç¬¦ï¼Œè«‹æ‰‹å‹•æ ¡æ­£`, 'info');
            } else { 
                panel.classList.add('hidden'); 
                btnRun.classList.remove('hidden'); 
                if(matchedCount > 0) showToast(`é©—è­‰å®Œæˆï¼š${matchedCount} äººåŒ¹é…æˆåŠŸ`, 'success'); 
            } 
        }

        function saveManualMappingsAndRun() { 
            const selects = document.querySelectorAll('#match-check-container select'); 
            selects.forEach(s => { 
                const orig = s.id.replace('fix-', ''); 
                if(s.value) appState.manualMappings[orig] = s.value; 
            }); 
            saveLocal(); 
            document.getElementById('match-check-panel').classList.add('hidden'); 
            document.getElementById('btn-run').classList.remove('hidden'); 
            handleAllocation(); 
        }

        // ... åœ¨ handleAllocation å‡½æ•¸å…§ ...
                for(let i=1; i<appState.rawPowerData.length; i++){ 
                    const r=appState.rawPowerData[i]; 
                    if(!r[ni]) continue; 
                    const n=r[ni];
                    const vRaw=r[vi]?r[vi].toString().replace(/,/g,''):"0";
                    const p=parseFloat(vRaw)||0; 
                    
                    // ã€ä¿®æ­£ã€‘æ”¾å¯¬åå­—é™åˆ¶ï¼Œåªè¦ä¸æ˜¯ function é—œéµå­—ä¸”é•·åº¦é©ä¸­å°±ä¿ç•™
                    if(!n || n.toString().includes('function')) continue; 
                    
                    const cleanName = normalizeName(n);
                    pMap[cleanName] = {raw:n, p, r:r[3]||""}; 
                } 
        }

       // --- æˆ°è¡“é‚è¼¯ ---
        function isLockedMember(m) { return m.reason.includes("é–å®š") || m.reason.includes("ç‰¹ä¾‹") || m.reason.includes("å…±æ§"); }
        
        // æ–°å¢ï¼šæª¢æŸ¥æ”¾å…¥æŸéšŠæ˜¯å¦å®‰å…¨ (ä¸æœƒè·ŸéšŠå‹è¡çª)
        function isSafeToJoin(player, targetTeam) {
            // 1. æª¢æŸ¥ç›®æ¨™éšŠä¼ä¸­ï¼Œæ˜¯å¦å·²ç¶“æœ‰åŒå®¶æ—çš„äºº (åŒéšŠè¡çª)
            const hasFamilyInTarget = targetTeam.members.some(m => m.fid === player.fid && m.name !== player.name);
            if (hasFamilyInTarget) return false;

            // 2. æª¢æŸ¥åŒå®¶æ—çš„äººæ˜¯å¦åœ¨ "åŒä¸€æ™‚é–“" çš„å…¶ä»–éšŠä¼ (æ’æœŸè¡çª)
            const sameTimeTeams = appState.teams.filter(t => t.active && t.id !== targetTeam.id && t.time === targetTeam.time);
            for (const t of sameTimeTeams) {
                const hasFamilyInSameTime = t.members.some(m => m.fid === player.fid && m.name !== player.name);
                if (hasFamilyInSameTime) return false;
            }
            return true;
        }

      // --- ä¿®æ­£å¾Œçš„ runTeamLogic å‡½æ•¸ ---
        // --- æ ¸å¿ƒåˆ†é…é‚è¼¯ (å®Œå…¨é‡å¯«) ---
        function runTeamLogic(mode = 'snake') {
            appState.lastLogicMode = mode;
            // 1. é‡ç½®éšŠä¼
            const validP = appState.players.slice();
            appState.teams.forEach(t => t.members = []);
            const activeTeams = appState.teams.filter(t => t.active).sort((a, b) => a.priority - b.priority);

            if (activeTeams.length === 0) return;

            // 2. æº–å‚™åå–®ï¼šæŒ‰æˆ°åŠ›é«˜ -> ä½æ’åº
            let remaining = [...validP].sort((a, b) => b.power - a.power);

            // 3. è™•ç†é–å®šåå–® (å…ˆä½”ä½)
            const assign = (p, tid, reason) => {
                const t = appState.teams.find(x => x.id === tid);
                if (t && t.active) {
                    p.team = tid; p.reason = reason; t.members.push(p);
                    const idx = remaining.findIndex(x => x.name === p.name);
                    if (idx > -1) remaining.splice(idx, 1);
                    return true;
                }
                return false;
            };

            // (é–å®šé‚è¼¯ä¿ç•™)
            [...remaining].forEach(p => {
                if (p.name.includes("åŠ¼å‰æ’ˆ") && !p.name.includes("ATM")) assign(p, 'jQt1', "R5 é–å®š");
                else if (p.name.includes("èººå¹³è‰ä»”ç²¿")) { 
                    const jQt2 = appState.teams.find(t => t.id === 'jQt2'); 
                    if (jQt2 && jQt2.active) assign(p, 'jQt2', "é–å®š jQt2"); 
                    else assign(p, 'aQt1', "é–å®š aQt1(å‚™æ¡ˆ)"); 
                }
                else if (p.name.includes("å†¬ä¾†å†¬å¾€")) assign(p, 'jQt1', "é–å®š jQt");
                else if (p.name.includes("å°å†¬å†¬")) { 
                    const jQt2 = appState.teams.find(t => t.id === 'jQt2'); 
                    if (jQt2 && jQt2.active) assign(p, 'jQt2', "é–å®š jQt"); 
                    else assign(p, 'jQt1', "é–å®š jQt"); 
                }
            });

            // 4. æ­£å¼åˆ†é… (ä¾æ“šè¨­å®šæ±ºå®šç­–ç•¥)
            remaining.forEach((p, i) => {
                let eligibleTeams = activeTeams;

                // å¦‚æœé–‹å•Ÿã€Œéµå¾ªå¿—é¡˜ã€ï¼Œä¸”è©²æˆå“¡æœ‰ç‰¹å®šå¿—é¡˜ (é any)
                if (appState.prioritizePreferences && p.prefTime !== 'any') {
                    // ç¯©é¸å‡ºç¬¦åˆæ™‚é–“çš„éšŠä¼
                    const timeMatches = activeTeams.filter(t => t.time === p.prefTime);
                    // å¦‚æœæœ‰ç¬¦åˆçš„éšŠä¼ï¼Œå°±åªå¾é€™äº›éšŠä¼é¸ï¼›å¦‚æœæ²’æœ‰(ä¾‹å¦‚è©²æ™‚æ®µéšŠä¼æ²’é–‹)ï¼Œå°±é€€å›å…¨é¸
                    if (timeMatches.length > 0) {
                        eligibleTeams = timeMatches;
                    }
                }

                // åœ¨ã€Œåˆæ ¼éšŠä¼ã€ä¸­ï¼Œé¸æ“‡æœ€é©åˆçš„ä¸€å€‹
                // ç­–ç•¥ï¼šç‚ºäº†å¹³è¡¡æˆ°åŠ›ï¼Œæˆ‘å€‘æŠŠäººä¸Ÿé€²ç›®å‰ã€Œç¸½æˆ°åŠ›æœ€ä½ã€çš„åˆæ ¼éšŠä¼
                // é€™æ˜¯ä¸€ç¨®å‹•æ…‹çš„ S å‹ (Water filling)
                eligibleTeams.sort((a, b) => {
                    const powerA = a.members.reduce((sum, m) => sum + m.power, 0);
                    const powerB = b.members.reduce((sum, m) => sum + m.power, 0);
                    // å¦‚æœæˆ°åŠ›ä¸€æ¨£ï¼Œé¸äººæ•¸å°‘çš„
                    if (powerA === powerB) return a.members.length - b.members.length;
                    return powerA - powerB; // é¸æˆ°åŠ›ä½çš„
                });

                const targetTeam = eligibleTeams[0];
                if (targetTeam) {
                    targetTeam.members.push(p);
                    p.team = targetTeam.id;
                    // å¦‚æœæ˜¯å› ç‚ºå¿—é¡˜æ‰é€²ä¾†çš„ï¼Œæ¨™è¨˜ä¸€ä¸‹
                    if (appState.prioritizePreferences && p.prefTime !== 'any' && p.prefTime === targetTeam.time) {
                        // é€™è£¡ä¸å¯«æ­» reasonï¼Œä¿ç•™å½ˆæ€§ï¼Œä½†é‚è¼¯ä¸Šå·²é”æˆ
                    }
                }
            });

            // 5. å¾Œè™•ç†ï¼šæ¢¯åº¦å„ªåŒ–èˆ‡è¡çªæª¢æŸ¥
            enforcePowerGradient(); 
            checkConflicts(); 
            renderDashboard();
        }

       function enforcePowerGradient() { 
            const active = appState.teams.filter(t => t.active).sort((a, b) => a.priority - b.priority); 
            const getPower = t => t.members.reduce((s, m) => s + m.power, 0); 
            let safety = 0; 
            
            while (safety++ < 50) { 
                let changed = false; 
                for (let i = 0; i < active.length - 1; i++) { 
                    const hi = active[i], lo = active[i + 1]; 
                    // åªæœ‰åœ¨ä¸åŒæ¢¯éšŠï¼ˆå¦‚åŒç‚º 22:00 çš„ä¸€äºŒè»ï¼‰ä¹‹é–“æ‰éœ€è¦åšæˆ°åŠ›æ¢¯åº¦
                    // å¦‚æœæ™‚é–“ä¸åŒï¼ˆä¾‹å¦‚ jQt1 æ˜¯ 22:00, jQt2 æ˜¯ 20:00ï¼‰ï¼Œé€šå¸¸ä¸éœ€è¦å¼·åˆ¶é«˜æˆ°åŠ›åœ¨å‰ï¼Œ
                    // ä½†å¦‚æœæ‚¨å¸Œæœ›å…¨ç›Ÿæœ€é«˜æˆ°åŠ›éƒ½åœ¨ç¬¬ä¸€éšŠï¼Œå‰‡ä¿æŒåŸç‹€ã€‚
                    // é€™è£¡å‡è¨­ï¼šä¸åŒæ™‚é–“çš„éšŠä¼ä¹‹é–“ï¼Œå¦‚æœé–‹å•Ÿã€Œå¿—é¡˜å„ªå…ˆã€ï¼Œå‰‡ä¸æ‡‰å› æˆ°åŠ›è€Œç¡¬æ›
                    if (appState.prioritizePreferences && hi.time !== lo.time) continue;

                    let pHi = getPower(hi), pLo = getPower(lo); 
                    if (pHi >= pLo) continue; 

                    const movableHi = hi.members.filter(m => !isLockedMember(m)); 
                    const movableLo = lo.members.filter(m => !isLockedMember(m)); 
                    
                    movableHi.sort((a, b) => a.power - b.power); 
                    movableLo.sort((a, b) => b.power - a.power); 
                    
                    let swapped = false; 
                    if (movableHi.length && movableLo.length) { 
                        const weakHi = movableHi[0], strongLo = movableLo[0]; 
                        if (strongLo.power > weakHi.power) { 
                            if (isSafeToJoin(strongLo, hi) && isSafeToJoin(weakHi, lo)) {
                                // ä¿è­·å¿—é¡˜ï¼šå¦‚æœé–‹å•Ÿå¿—é¡˜å„ªå…ˆï¼Œæª¢æŸ¥äº¤æ›å¾Œæ˜¯å¦æœƒé•åå¿—é¡˜
                                let prefOk = true;
                                if (appState.prioritizePreferences) {
                                    if (strongLo.prefTime !== 'any' && strongLo.prefTime !== hi.time) prefOk = false;
                                    if (weakHi.prefTime !== 'any' && weakHi.prefTime !== lo.time) prefOk = false;
                                }

                                if (prefOk) {
                                    hi.members.splice(hi.members.indexOf(weakHi), 1); 
                                    lo.members.splice(lo.members.indexOf(strongLo), 1); 
                                    weakHi.team = lo.id; weakHi.reason = "æ¢¯åº¦èª¿æ•´"; 
                                    strongLo.team = hi.id; strongLo.reason = "æ¢¯åº¦èª¿æ•´"; 
                                    lo.members.push(weakHi); hi.members.push(strongLo); 
                                    swapped = true; changed = true; 
                                }
                            }
                        } 
                    } 
                } 
                if (!changed) break; 
            } 
        }

        function checkConflicts(){ 
            let c=0; 
            appState.conflictMap={}; 
            const activeTeamCount = appState.teams.filter(t=>t.active).length; 
            const allAssigned = appState.teams.flatMap(t => t.members); 
            const groups = {}; 
            allAssigned.forEach(p => { if(!groups[p.fid]) groups[p.fid] = []; groups[p.fid].push(p); }); 
            for(const fid in groups) { 
                const fam = groups[fid]; 
                if(fam.length > 1) { 
                    for(let i=0; i<fam.length; i++) { 
                        for(let j=i+1; j<fam.length; j++) { 
                            const p1 = fam[i], p2 = fam[j]; 
                            const t1 = appState.teams.find(t=>t.id===p1.team), t2 = appState.teams.find(t=>t.id===p2.team); 
                            if(t1 && t2) { 
                                if(activeTeamCount > 1 && t1.id === t2.id) { 
                                    c++; appState.conflictMap[p1.name] = "ğŸš«åŒéšŠ"; appState.conflictMap[p2.name] = "ğŸš«åŒéšŠ"; 
                                } else if(t1.time === t2.time && t1.id !== t2.id) { 
                                    if(!appState.conflictMap[p1.name]) { c++; appState.conflictMap[p1.name] = "âš ï¸æ’æœŸ"; appState.conflictMap[p2.name] = "âš ï¸æ’æœŸ"; } 
                                } 
                            } 
                        } 
                    } 
                } 
            } 
            setText('stat-conflict', c); 
        }

        // --- ä¿®æ­£å¾Œçš„å¿—é¡˜æ ¡æ­£é‚è¼¯ ---
        function autoCorrectPreferences(isAuto = false) {
            let swapCount = 0; 
            const activeTeams = appState.teams.filter(t => t.active); 
            let wrongPlaceMembers = [];

            // 1. æ‰¾å‡ºæ‰€æœ‰ã€Œæ²’å»åˆ°æƒ³å»æ™‚æ®µã€çš„äºº
            activeTeams.forEach(sourceTeam => { 
                sourceTeam.members.forEach(m => { 
                    if (m.prefTime !== 'any' && m.prefTime !== sourceTeam.time && !isLockedMember(m)) { 
                        wrongPlaceMembers.push({ member: m, sourceTeam: sourceTeam }); 
                    } 
                }); 
            });

            if (wrongPlaceMembers.length === 0 && !isAuto) return showToast("æ‰€æœ‰æˆå“¡çš†ç¬¦åˆå¿—é¡˜", "info");

            // 2. å˜—è©¦äº¤æ›
            wrongPlaceMembers.forEach(item => {
                const { member, sourceTeam } = item; 
                // ç¢ºä¿äººé‚„åœ¨åŸéšŠä¼ (å¯èƒ½åœ¨è¿´åœˆä¸­è¢«æ›èµ°äº†)
                if (!sourceTeam.members.includes(member)) return;

                // æ‰¾åˆ°ç›®æ¨™æ™‚é–“çš„éšŠä¼
                const targetTeam = activeTeams.find(t => t.time === member.prefTime);
                if (targetTeam) {
                    // åœ¨ç›®æ¨™éšŠä¼æ‰¾ä¸€å€‹ã€Œå¯ä»¥æ›éä¾†ã€çš„äºº (å€™é¸äºº)
                    // æ¢ä»¶ A: å€™é¸äººæƒ³å» sourceTeam çš„æ™‚é–“ (å®Œç¾äº¤æ›)
                    // æ¢ä»¶ B: å€™é¸äººæ˜¯ 'any' (ç„¡æ‰€è¬‚)
                    let candidate = targetTeam.members.find(tMember => !isLockedMember(tMember) && tMember.prefTime === sourceTeam.time);
                    if (!candidate) candidate = targetTeam.members.find(tMember => !isLockedMember(tMember) && tMember.prefTime === 'any');
                    
                    if (candidate) {
                        // ã€é—œéµä¿®æ­£ã€‘ äº¤æ›å‰å¿…é ˆæª¢æŸ¥ï¼šæ›éå»æ˜¯å¦æœƒé€ æˆã€Œå®¶æ—è¡çªã€ï¼Ÿ
                        // 1. ä¸»è§’å»ç›®æ¨™éšŠä¼å®‰å…¨å—ï¼Ÿ
                        // 2. å€™é¸äººä¾†ä¾†æºéšŠä¼å®‰å…¨å—ï¼Ÿ
                        if (isSafeToJoin(member, targetTeam) && isSafeToJoin(candidate, sourceTeam)) {
                            // åŸ·è¡Œäº¤æ›
                            sourceTeam.members = sourceTeam.members.filter(m => m !== member); 
                            targetTeam.members = targetTeam.members.filter(m => m !== candidate);
                            
                            member.team = targetTeam.id; member.reason = "å¿—é¡˜æ ¡æ­£"; 
                            candidate.team = sourceTeam.id; candidate.reason = "å¿—é¡˜æ ¡æ­£(äº¤æ›)";
                            
                            targetTeam.members.push(member); 
                            sourceTeam.members.push(candidate); 
                            swapCount++;
                        }
                    }
                }
            });

            if (swapCount > 0) { 
                if (!isAuto) { checkConflicts(); renderDashboard(); showToast(`å·²èª¿æ•´ ${swapCount} ä½æˆå“¡`, 'success'); } 
            } else if (!isAuto) { showToast("ç„¡æ³•é€²è¡Œæ›´å¤šå®‰å…¨äº¤æ›", "info"); }
        }

        // --- ä¿®æ­£å¾Œçš„è¡çªè§£æ±ºé‚è¼¯ ---
        // --- æ•´åˆå¾Œçš„è¡çªèˆ‡å¿—é¡˜ä¿®å¾©é‚è¼¯ ---
        function autoResolveConflicts() { 
            const activeTeams = appState.teams.filter(t => t.active);
            if (activeTeams.length < 2) return showToast("å–®ä¸€è»åœ˜æ¨¡å¼ç„¡éœ€è§£æ±ºè¡çª"); 

            let totalFixed = 0;
            let maxLoops = 20; // å¢åŠ è¿´åœˆæ•¸ä»¥è™•ç†è¤‡é›œæƒ…æ³

            for (let loop = 0; loop < maxLoops; loop++) {
                checkConflicts(); // æ›´æ–°è¡çªç‹€æ…‹
                
                // 1. æ”¶é›†æ‰€æœ‰éœ€è¦è™•ç†çš„äºº (åŒ…å«è¡çªè€… + å¿—é¡˜ä¸ç¬¦è€…)
                let issues = [];
                
                // A. å®¶æ—/åŒéšŠè¡çª (é«˜å„ªå…ˆç´š)
                Object.keys(appState.conflictMap).forEach(name => {
                    const t = activeTeams.find(t => t.members.some(m => m.name === name));
                    const m = t ? t.members.find(m => m.name === name) : null;
                    if (m && !isLockedMember(m)) issues.push({ member: m, team: t, type: 'conflict', priority: 10 });
                });

                // B. å¿—é¡˜ä¸ç¬¦ (ä¸­å„ªå…ˆç´šï¼Œåƒ…åœ¨é–‹å•Ÿéµå¾ªå¿—é¡˜æ™‚åŠ å…¥)
                if (appState.prioritizePreferences) {
                    activeTeams.forEach(t => {
                        t.members.forEach(m => {
                            if (m.prefTime !== 'any' && m.prefTime !== t.time && !isLockedMember(m)) {
                                // é¿å…é‡è¤‡åŠ å…¥
                                if (!issues.find(i => i.member === m)) {
                                    issues.push({ member: m, team: t, type: 'pref', priority: 5 });
                                }
                            }
                        });
                    });
                }

                if (issues.length === 0) break; // æ²’å•é¡Œå°±çµæŸ

                // ä¾å„ªå…ˆç´šæ’åº (å…ˆè§£è¡çªï¼Œå†è§£å¿—é¡˜)
                issues.sort((a, b) => b.priority - a.priority);

                let changedInLoop = false;

                // å˜—è©¦è§£æ±ºæ¯ä¸€å€‹å•é¡Œ
                for (let issue of issues) {
                    const { member: player, team: currentTeam, type } = issue;
                    
                    // å°‹æ‰¾ç›®æ¨™éšŠä¼
                    // å¦‚æœæ˜¯è¡çªï¼šæ‰¾ä¸åŒ ID ä¸” ä¸åŒæ™‚é–“(å¦‚æœæ˜¯æ’æœŸ) çš„éšŠä¼
                    // å¦‚æœæ˜¯å¿—é¡˜ï¼šæ‰¾ç¬¦åˆå¿—é¡˜æ™‚é–“çš„éšŠä¼
                    let targetTeams = [];
                    if (type === 'pref') {
                        targetTeams = activeTeams.filter(t => t.time === player.prefTime);
                    } else {
                        // è¡çªè™•ç†ï¼šå„ªå…ˆæ‰¾å®Œå…¨æ²’è¡çªçš„éšŠä¼
                        targetTeams = activeTeams.filter(t => t.id !== currentTeam.id && t.time !== currentTeam.time);
                        // å¦‚æœæ‰¾ä¸åˆ°ä¸åŒæ™‚é–“çš„ï¼Œåªå¥½æ‰¾åŒæ™‚é–“ä½†ä¸åŒéšŠçš„ (è§£æ±ºåŒéšŠè¡çª)
                        if (targetTeams.length === 0) targetTeams = activeTeams.filter(t => t.id !== currentTeam.id);
                    }

                    let swapSuccess = false;

                    for (let targetTeam of targetTeams) {
                        // æ‰¾å€™é¸äºº (å¯ä»¥è·Ÿ player äº¤æ›çš„äºº)
                        // æ¢ä»¶ï¼šéé–å®š
                        let candidates = targetTeam.members.filter(m => !isLockedMember(m));
                        
                        // æ’åºå€™é¸äººï¼šæˆ°åŠ›å·®è·è¶Šå°è¶Šå¥½
                        candidates.sort((a, b) => Math.abs(a.power - player.power) - Math.abs(b.power - player.power));

                        for (let candidate of candidates) {
                            // æˆ°åŠ›é–€æª»æ”¾å¯¬ (éš¨è‘—è¿´åœˆæ¬¡æ•¸å¢åŠ )
                            let limit = 500000 + (loop * 500000); 
                            if (Math.abs(candidate.power - player.power) > limit) continue;

                            // === é—œéµé‚è¼¯ï¼šäº¤æ›æ¨¡æ“¬ ===
                            // 1. Player å» TargetTeam å®‰å…¨å—ï¼Ÿ (ç„¡å®¶æ—è¡çª)
                            if (!isSafeToJoin(player, targetTeam)) continue;
                            // 2. Candidate ä¾† CurrentTeam å®‰å…¨å—ï¼Ÿ
                            if (!isSafeToJoin(candidate, currentTeam)) continue;

                            // 3. å¦‚æœæ˜¯ç‚ºäº†è§£æ±ºå¿—é¡˜ï¼Œæª¢æŸ¥ Candidate æ˜¯å¦é¡˜æ„éä¾† (æˆ–è€…æ˜¯ any)
                            // é¿å…æŠŠåŸæœ¬å°±åœ¨æ»¿æ„ä½ç½®çš„äººæ›èµ°
                            if (type === 'pref') {
                                // å¦‚æœå€™é¸äººä¹Ÿæ˜¯æŒ‡å®šæ™‚é–“ï¼Œä¸”ä»–ç¾åœ¨å°±åœ¨å°çš„æ™‚é–“ï¼Œåˆ¥å‹•ä»–
                                if (candidate.prefTime !== 'any' && candidate.prefTime === targetTeam.time) continue;
                            }
                            
                            // 4. å¦‚æœæ˜¯ç‚ºäº†è§£æ±ºè¡çªï¼Œä¸”é–‹å•Ÿäº†å¿—é¡˜å„ªå…ˆï¼Œè¦ç›¡é‡é¿å…è£½é€ æ–°çš„å¿—é¡˜ä¸ç¬¦
                            if (type === 'conflict' && appState.prioritizePreferences) {
                                // å¦‚æœäº¤æ›æœƒå°è‡´åŸæœ¬æ»¿æ„çš„äººè®Šä¸æ»¿æ„ï¼Œç›¡é‡é¿å… (é™¤éæ²’æ‹›äº† loop > 10)
                                if (loop < 10 && candidate.prefTime === targetTeam.time && candidate.prefTime !== 'any') continue;
                            }

                            // åŸ·è¡Œäº¤æ›
                            currentTeam.members = currentTeam.members.filter(m => m !== player);
                            targetTeam.members = targetTeam.members.filter(m => m !== candidate);
                            
                            player.team = targetTeam.id; 
                            player.reason = type === 'conflict' ? "è¡çªä¿®å¾©" : "å¿—é¡˜æ ¡æ­£";
                            
                            candidate.team = currentTeam.id; 
                            candidate.reason = "äº¤æ›èª¿æ•´";
                            
                            targetTeam.members.push(player);
                            currentTeam.members.push(candidate);
                            
                            changedInLoop = true; 
                            swapSuccess = true; 
                            totalFixed++; 
                            break; 
                        }
                        if (swapSuccess) break;
                    }
                }
                if (!changedInLoop) break; // é€™ä¸€è¼ªéƒ½æ²’å‹•éœï¼Œå¤§æ¦‚è§£ä¸æ‰äº†ï¼Œé€€å‡º
            }

            checkConflicts(); 
            renderDashboard(); 
            
            if (totalFixed > 0) showToast(`å·²è‡ªå‹•èª¿æ•´ ${totalFixed} è™•è¨­ç½®`, 'success'); 
            else {
                const conflictCount = Object.keys(appState.conflictMap).length;
                if(conflictCount > 0) showToast(`ä»æœ‰ ${conflictCount} å€‹è¡çªç„¡æ³•è‡ªå‹•è§£æ±º`, 'warning');
                else if (appState.prioritizePreferences) showToast("è¡çªèˆ‡å¿—é¡˜çš†å·²æœ€ä½³åŒ–", 'success');
                else showToast("ç„¡è¡çªéœ€è¦è§£æ±º", 'success');
            }
        }

        function manualRemove(name) { 
            if(!confirm(`ç¢ºå®šè¦å°‡ã€Œ${name}ã€ç§»é™¤å—ï¼Ÿ`)) return; 
            let removedPlayer = null; 
            appState.teams.forEach(t => { const idx = t.members.findIndex(m => m.name === name); if(idx > -1) removedPlayer = t.members.splice(idx, 1)[0]; }); 
            const pIdx = appState.players.findIndex(p => p.name === name); 
            if(pIdx > -1) { if(!removedPlayer) removedPlayer = appState.players[pIdx]; appState.players.splice(pIdx, 1); } 
            if(removedPlayer) { 
                removedPlayer.opt = 'æ‰‹å‹•ç§»é™¤'; appState.absentPlayers.push(removedPlayer); 
                runTeamLogic(appState.lastLogicMode); showToast(`å·²ç§»é™¤ ${name}`, 'success'); 
            } 
        }

        function manualRestore(name) { 
            const idx = appState.absentPlayers.findIndex(p => p.name === name); 
            if(idx > -1) { 
                const player = appState.absentPlayers.splice(idx, 1)[0]; 
                player.reason = ''; player.team = null; appState.players.push(player); 
                runTeamLogic(appState.lastLogicMode); showToast(`å·²æ¢å¾© ${name}`, 'success'); 
            } 
        }

        // --- è¦–è¦ºåŒ–èˆ‡äº’å‹• ---
        function createTeamChart(t) { 
            const ctx = document.getElementById(`chart-${t.id}`); 
            if(ctx) { 
                // å–å¾—åˆ†ä½ˆæ•¸æ“š
                const { counts } = getPowerDistribution(t.members);
                
                // è¨­å®šé¡è‰²
                const color = t.id.includes('jQt') ? 'rgba(59, 130, 246, 1)' : 'rgba(249, 115, 22, 1)'; 
                const bg = t.id.includes('jQt') ? 'rgba(59, 130, 246, 0.1)' : 'rgba(249, 115, 22, 0.1)'; 
                
                if(teamCharts[t.id]) teamCharts[t.id].destroy(); 
                
                teamCharts[t.id] = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        // æ¨™ç±¤ï¼šT1(é«˜) ~ T5(ä½)
                        labels: ['T1', 'T2', 'T3', 'T4', 'T5'], 
                        datasets: [{ 
                            data: counts, 
                            borderColor: color, 
                            backgroundColor: bg, 
                            borderWidth: 1.5, 
                            pointRadius: 2, // é¡¯ç¤ºå°åœ“é»ä»¥ä¾¿çœ‹æ¸…äººæ•¸è½é»
                            fill: true, 
                            tension: 0.3 // ç¨å¾®åœ“æ»‘ä¸€é»
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }, 
                        scales: { 
                            x: { display: false }, 
                            // Yè»¸å¾0é–‹å§‹ï¼Œç¢ºä¿æ¯”ä¾‹æ­£ç¢º
                            y: { display: false, min: 0, suggestedMax: Math.max(...counts) + 1 } 
                        } 
                    } 
                }); 
            } 
        }
        // å®šç¾©å…¨åŸŸè®Šæ•¸ä»¥ç®¡ç†æ–°åœ–è¡¨å¯¦ä¾‹
        let globalDistChartInstance = null;

        function renderChart() {
            const activeTeams = appState.teams.filter(t => t.active);
            
            // --- 1. ç¹ªè£½åŸæœ¬çš„ï¼šè»åœ˜ç¸½æˆ°åŠ›æ¯”è¼ƒ (æ©«å‘é•·æ¢åœ–) ---
            const ctxGlobal = document.getElementById('powerChart');
            if (chartInstance) chartInstance.destroy();
            const divisor = 1000; 
            
            if (ctxGlobal) {
                chartInstance = new Chart(ctxGlobal, {
                    type: 'bar',
                    data: {
                        labels: activeTeams.map(t => t.name),
                        datasets: [{ 
                            label: 'ç¸½æˆ°åŠ› (k)', 
                            data: activeTeams.map(t => (t.members.reduce((a, b) => a + b.power, 0) / divisor).toFixed(0)), 
                            backgroundColor: activeTeams.map(t => t.id.includes('jQt') ? 'rgba(59, 130, 246, 0.7)' : 'rgba(249, 115, 22, 0.7)'), 
                            borderColor: activeTeams.map(t => t.id.includes('jQt') ? 'rgba(59, 130, 246, 1)' : 'rgba(249, 115, 22, 1)'), 
                            borderWidth: 1 
                        }]
                    },
                    options: { 
                        indexAxis: 'y', 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } }, 
                        scales: { x: { beginAtZero: true, grid: { display: false } } } 
                    }
                });
            }

            // --- 2. æ–°å¢ï¼šå…¨é«”äººå“¡æˆ°åŠ›å€é–“åˆ†ä½ˆ (æŠ˜ç·šåœ–) ---
            const ctxDist = document.getElementById('globalDistChart');
            if (globalDistChartInstance) globalDistChartInstance.destroy();

            if (ctxDist && appState.players.length > 0) {
                // ä½¿ç”¨å…ˆå‰å®šç¾©çš„ getPowerDistribution è¨ˆç®—å…¨é«”åˆ†ä½ˆ
                const { counts, mRatio } = getPowerDistribution(appState.players);
                
                // æ›´æ–° M å‹ä¿‚æ•¸æ¨™ç±¤é¡è‰²
                const mBadge = document.getElementById('global-m-ratio');
                if(mBadge) {
                    mBadge.innerText = `Må‹: ${mRatio}%`;
                    if(mRatio >= 40) mBadge.className = "text-xs font-bold text-white bg-red-500 px-2 py-0.5 rounded shadow-sm animate-pulse";
                    else if(mRatio >= 20) mBadge.className = "text-xs font-bold text-white bg-amber-500 px-2 py-0.5 rounded";
                    else mBadge.className = "text-xs font-bold text-slate-600 bg-slate-200 px-2 py-0.5 rounded";
                }

                globalDistChartInstance = new Chart(ctxDist, {
                    type: 'line',
                    data: {
                        labels: ['T1(é«˜)', 'T2', 'T3', 'T4', 'T5(ä½)'],
                        datasets: [{
                            label: 'äººæ•¸',
                            data: counts,
                            borderColor: 'rgba(99, 102, 241, 1)', // Indigo 500
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: 'white',
                            pointBorderColor: 'rgba(99, 102, 241, 1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { 
                                intersect: false,
                                callbacks: {
                                    title: () => `å…¨é«” M å‹åŒ–: ${mRatio}%`
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                display: true,
                                ticks: { stepSize: 1, font: { size: 10 } },
                                grid: { color: '#f1f5f9' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 10 } }
                            }
                        }
                    }
                });
            }
        }

        function cycleTeam(name){ 
            const active=appState.teams.filter(t=>t.active); 
            if(active.length<2) return; 
            for(let i=0; i<active.length; i++){ 
                const t=active[i], m=t.members.find(x=>x.name===name); 
                if(m){ 
                    t.members=t.members.filter(x=>x!==m); 
                    const next=active[(i+1)%active.length]; 
                    m.team=next.id; m.reason="æ‰‹å‹•"; next.members.push(m); 
                    checkConflicts(); renderDashboard(); return; 
                } 
            } 
        }

        function exportToDiscord() { 
            let text = `**ğŸ° jQt è¯ç›Ÿæˆ°åŠ›é…ç½® (v68.1)**\nğŸ“… æ—¥æœŸ: ${new Date().toLocaleDateString()}\n\n`; 
            appState.teams.filter(t => t.active).forEach(t => { 
                const totalPower = Math.round(t.members.reduce((a,b)=>a+b.power,0)/1000).toLocaleString(); 
                text += `**${t.name}** (${t.time}) - ${t.members.length}äºº - ${totalPower}k\n> æˆå“¡: ${t.members.map(m=>m.name).join(', ')}\n\n`; 
            }); 
            const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showToast("å·²è¤‡è£½ Discord æ ¼å¼ï¼", 'success'); 
        }

        function copyMemberList() { 
            const dateStr = new Date().toLocaleDateString(); 
            let text = `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ° jQt è¯ç›Ÿè»åœ˜åå–®\nğŸ“… ${dateStr}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`; 
            let totalCount = 0; let totalPower = 0; 
            appState.teams.filter(t => t.active).forEach(t => { 
                const tCount = t.members.length; 
                const tPower = t.members.reduce((a,b)=>a+b.power,0); 
                const avgPower = tCount > 0 ? (tPower / tCount) : 0; 
                totalCount += tCount; totalPower += tPower; 
                text += `ã€${t.name}ã€‘\nâ° æ™‚é–“ï¼š${t.time}\nğŸ‘¥ äººæ•¸ï¼š${tCount} äºº\nâš”ï¸ ç¸½æˆ°åŠ›ï¼š${formatSmart(tPower)}\nğŸ“Š å¹³å‡ï¼š${formatSmart(avgPower)}\n\næˆå“¡åå–®ï¼š\n`; 
                const names = t.members.map(m => m.name); 
                for (let i = 0; i < names.length; i += 5) text += names.slice(i, i + 5).join('ã€') + '\n'; 
                text += `\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`; 
            }); 
            text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“Š ç¸½è¨ˆï¼š${totalCount} äººåƒæˆ°\nğŸ’ª ç¸½æˆ°åŠ›ï¼š${formatSmart(totalPower)}\n\n`; 
            if (appState.absentPlayers.length > 0) { 
                text += `ğŸš« ä¸åƒåŠ åå–® (${appState.absentPlayers.length}äºº)ï¼š\n`; 
                const absNames = appState.absentPlayers.map(p => p.name); 
                for (let i = 0; i < absNames.length; i += 5) text += absNames.slice(i, i + 5).join('ã€') + '\n'; 
            } 
            const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showToast("å·²è¤‡è£½å®Œæ•´åå–®ï¼", 'success'); 
        }

        // --- å­˜æª”/é»å/è¨­å®š ---
        function saveConfiguration() { 
            const name = document.getElementById('save-name')?.value || `é…ç½® ${new Date().toLocaleString()}`; 
            if (appState.savedConfigs.length > 20) appState.savedConfigs.shift(); 
            appState.savedConfigs.push({ id: Date.now(), name: name, date: new Date().toLocaleString(), players: appState.players, mappings: appState.manualMappings }); 
            localStorage.setItem('jQt_history', JSON.stringify(appState.savedConfigs)); 
            renderHistoryList(); showToast("é…ç½®å·²å„²å­˜", 'success'); 
        }

        function loadConfiguration(id) { 
            const config = appState.savedConfigs.find(c => c.id === id); 
            if (config) { appState.players = config.players; appState.manualMappings = config.mappings; runTeamLogic('snake'); showToast(`å·²è¼‰å…¥: ${config.name}`, 'success'); } 
        }

        function deleteConfiguration(id) { 
            appState.savedConfigs = appState.savedConfigs.filter(c => c.id !== id); 
            localStorage.setItem('jQt_history', JSON.stringify(appState.savedConfigs)); renderHistoryList(); 
        }

        function renderHistoryList() { 
            const el = document.getElementById('history-list'); if (!el) return; 
            if (appState.savedConfigs.length === 0) { el.innerHTML = '<div class="text-center text-slate-400 py-4 text-sm">å°šç„¡å­˜æª”</div>'; return; } 
            el.innerHTML = appState.savedConfigs.slice().reverse().map(c => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded border-b last:border-0 hover:bg-slate-100 transition-colors"><div><div class="font-bold text-sm text-slate-700">${c.name}</div><div class="text-xs text-slate-500">${c.date}</div></div><div class="flex gap-2"><button onclick="loadConfiguration(${c.id})" class="text-indigo-600 hover:text-indigo-800 font-bold text-xs">è¼‰å…¥</button><button onclick="deleteConfiguration(${c.id})" class="text-red-400 hover:text-red-600 font-bold text-xs">åˆªé™¤</button></div></div>`).join(''); 
        }

        function exportConfig() { 
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState.savedConfigs)); 
            const downloadAnchorNode = document.createElement('a'); 
            downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "jQt_configs.json"); 
            document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); 
        }

        function importConfig(input) { 
            const file = input.files[0]; if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                try { 
                    const imported = JSON.parse(e.target.result); 
                    if(Array.isArray(imported)) { 
                        appState.savedConfigs = [...appState.savedConfigs, ...imported]; 
                        localStorage.setItem('jQt_history', JSON.stringify(appState.savedConfigs)); 
                        renderHistoryList(); showToast("åŒ¯å…¥æˆåŠŸ", 'success'); 
                    } else throw new Error("æ ¼å¼ä¸ç¬¦"); 
                } catch(err) { showToast("åŒ¯å…¥å¤±æ•—: æ ¼å¼éŒ¯èª¤", 'error'); } 
            }; reader.readAsText(file); 
        }

        function initTactics(){ 
            const s=document.getElementById('tactics-team-select'); 
            s.innerHTML=appState.teams.filter(t=>t.active).map(t=>`<option value="${t.id}">${t.name}</option>`).join(''); 
            if(!appState.currentTacticalTeamId) appState.currentTacticalTeamId=s.value; else s.value=appState.currentTacticalTeamId; 
            renderTacticsBoard(); 
        }

        function renderTacticsBoard(){ 
            const tid=document.getElementById('tactics-team-select').value; 
            appState.currentTacticalTeamId=tid; 
            const team=appState.teams.find(t=>t.id===tid); 
            if(!team)return; 
            let pwr={1:0,2:0,3:0,4:0}; 
            team.members.forEach(m=>{if(m.missionGroup>0)pwr[m.missionGroup]+=m.power;}); 
            const c=document.getElementById('tactics-container'); c.innerHTML=''; 
            MISSION_GROUPS.forEach(g=>{ 
                const mems=team.members.filter(m=>m.missionGroup===g.id).sort((a,b)=>b.power-a.power); 
                let list=mems.map(m=> { 
                    const safeName = m.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;'); 
                    return `<div class="member-row" onclick="cycleGroup('${safeName}')"><span class="font-bold">${m.name}</span><span class="text-xs text-slate-500">${Math.round(m.power/1000)}k</span></div>` 
                }).join(''); 
                c.innerHTML+=`<div class="mission-group-card border-${g.color}-500"><div class="mission-header text-${g.color}-700 flex items-center justify-between px-2 py-1 border-b"><span>${g.name}</span><span class="text-sm bg-white px-2 border rounded shadow-sm">${Math.round(pwr[g.id]/1000)}k</span></div><div class="mission-target text-xs text-slate-600 p-2 border-b bg-slate-50">${g.target.replace(/\n/g,'<br>')}</div><div class="h-64 overflow-y-auto custom-scroll">${list}</div></div>`; 
            }); 
            const gn=(id)=>team.members.filter(m=>m.missionGroup===id).sort((a,b)=>b.power-a.power).map(m=>m.name).join(', '); 
            document.getElementById('mission-text').value=`ã€${team.name} æˆ°å ´æŒ‡ä»¤ã€‘\n` + MISSION_GROUPS.map(g=>`\n${g.name}\n${g.target}\næˆå“¡: ${gn(g.id)||"ç„¡"}`).join('\n'); 
        }

        function cycleGroup(name){ const t=appState.teams.find(x=>x.id===appState.currentTacticalTeamId); const m=t.members.find(x=>x.name===name); if(m){ m.missionGroup=(m.missionGroup%4)+1; renderTacticsBoard(); } }
        function autoDistributeMissions(){ const t=appState.teams.find(x=>x.id===appState.currentTacticalTeamId); const s=[...t.members].sort((a,b)=>b.power-a.power); s.forEach((m,i)=>{ const c=Math.floor(i/4), p=i%4; m.missionGroup=(c%2===0) ? (p+1) : (4-p); }); renderTacticsBoard(); }
        function copyMissionText(){ const e=document.getElementById('mission-text'); e.select(); document.execCommand('copy'); showToast('æˆ°è¡“æŒ‡ä»¤å·²è¤‡è£½', 'success'); }
        
        function renderSettings(){ 
            const tb=document.getElementById('team-list-body'); 
            if(tb){ tb.innerHTML=''; appState.teams.forEach((t)=>{ tb.innerHTML+=`<tr class="border-b"><td class="p-2">${t.name}</td><td class="p-2">${t.time}</td><td class="p-2"><span class="text-xs px-2 py-1 rounded ${t.active?'bg-green-100 text-green-700':'bg-slate-100 text-slate-400'}">${t.active?'å•Ÿç”¨':'é—œé–‰'}</span></td></tr>`; }); } 
            const ab=document.getElementById('bind-list-body'); 
            if(ab){ ab.innerHTML=''; appState.alts.forEach((a,i)=>{ ab.innerHTML+=`<tr class="border-b"><td class="p-2">${a.main}</td><td class="p-2">${a.alt}</td><td class="p-2"><button onclick="delAlt(${i})" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸ åˆªé™¤</button></td></tr>`; }); } 
            renderLinkerList(); 
        }

        function renderLinkerList(){ 
            const lc=document.getElementById('linker-container'); if(!lc) return; 
            lc.innerHTML=''; 
            if(appState.unknownPlayers.length === 0) { lc.innerHTML = '<p class="text-sm text-green-600">ç›®å‰æ²’æœ‰éœ€è¦æ ¡æº–çš„æˆå“¡ã€‚</p>'; return; } 
            const opts=appState.availablePowerNames.filter(n=>!n.includes('function')&&n.length<30); 
            appState.unknownPlayers.forEach(p=>{ 
                const sel=p.guess; 
                const sOpts=[...opts].sort((a,b)=>{ if(a===sel)return -1; if(b===sel)return 1; return a.localeCompare(b); }); 
                const h=`<option value="">è«‹é¸æ“‡å°æ‡‰ ID</option>` + sOpts.map(n=>`<option value="${n}" ${n===sel?'selected':''}>${n}</option>`).join(''); 
                lc.innerHTML+=`<div class="flex gap-2 items-center mb-2"><input disabled value="${p.name}" class="w-1/3 text-xs border p-2 rounded bg-slate-100 font-bold text-slate-700"><span class="text-slate-400">ğŸ‘‰</span><select id="map-${p.name}" class="w-2/3 text-xs border p-2 rounded bg-white shadow-sm focus:border-amber-500">${h}</select></div>`; 
            }); 
        }

        function addBinding(){ const m=document.getElementById('bind-main').value, a=document.getElementById('bind-alt').value; if(m&&a){ appState.alts.push({main:m, alt:a}); saveLocal(); renderSettings(); document.getElementById('bind-main').value=''; document.getElementById('bind-alt').value=''; showToast('ç¶å®šå·²æ–°å¢', 'success'); } }
        function delAlt(i){ appState.alts.splice(i,1); saveLocal(); renderSettings(); }
        function applyManualMappings(){ let c=0; appState.unknownPlayers.forEach(p=>{ const e=document.getElementById(`map-${p.name}`); if(e&&e.value){ appState.manualMappings[p.name]=e.value; c++; } }); if(c){ saveLocal(); handleAllocation(); showToast('æ ¡æ­£å·²å¥—ç”¨', 'success'); } else showToast("æœªé¸æ“‡ä»»ä½•å°æ‡‰é—œä¿‚", 'info'); }
        function clearManualMappings() { if(confirm("ç¢ºå®šè¦åˆªé™¤æ ¡æ­£ç´€éŒ„å—ï¼Ÿ")) { appState.manualMappings = {}; saveLocal(); verifyNames(); showToast('ç´€éŒ„å·²æ¸…é™¤', 'success'); } }
        
        function initAttendance() { 
            const activeTeams = appState.teams.filter(t => t.active); 
            if (activeTeams.length === 0) return showToast("ç„¡å•Ÿç”¨è»åœ˜", 'error'); 
            const date = new Date().toLocaleDateString(); 
            setText('att-date-display', `ğŸ“… ${date} é»å`); 
            appState.currentAttendance = { date: date, id: Date.now(), records: {} }; 
            const container = document.getElementById('attendance-container'); container.innerHTML = ''; 
            activeTeams.forEach(t => { 
                let rows = t.members.map(m => { 
                    appState.currentAttendance.records[m.name] = 'present'; 
                    return `<div class="flex justify-between items-center py-2 border-b last:border-0"><span class="font-bold text-slate-700 text-sm w-32 truncate">${m.name}</span><div class="flex gap-2"><button onclick="setAttStatus('${m.name}', 'present')" id="att-btn-${m.name}-present" class="att-btn present active" title="å‡ºå¸­">âœ“</button><button onclick="setAttStatus('${m.name}', 'leave')" id="att-btn-${m.name}-leave" class="att-btn leave" title="è«‹å‡">â—</button><button onclick="setAttStatus('${m.name}', 'absent')" id="att-btn-${m.name}-absent" class="att-btn absent" title="ç¼ºå¸­">âœ—</button></div></div>`; 
                }).join(''); 
                container.innerHTML += `<div class="bg-white rounded-lg shadow border p-4"><h4 class="font-bold text-lg mb-2 text-indigo-700 border-b pb-2">${t.name} (${t.members.length}äºº)</h4><div class="max-h-96 overflow-y-auto custom-scroll">${rows}</div></div>`; 
            }); 
            document.getElementById('attendance-active-area').classList.remove('hidden'); 
        }

        function setAttStatus(name, status) { appState.currentAttendance.records[name] = status; document.querySelectorAll(`[id^="att-btn-${name}-"]`).forEach(b => b.classList.remove('active')); document.getElementById(`att-btn-${name}-${status}`).classList.add('active'); }
        function markAllPresent() { for (let name in appState.currentAttendance.records) { setAttStatus(name, 'present'); } }
        function saveAttendance() { if (!appState.currentAttendance.id) return showToast("è«‹å…ˆé–‹å§‹æ–°é»å", 'error'); appState.attendanceHistory.push(appState.currentAttendance); localStorage.setItem('jQt_attendance', JSON.stringify(appState.attendanceHistory)); renderAttendanceHistory(); document.getElementById('attendance-active-area').classList.add('hidden'); showToast("é»åè¨˜éŒ„å·²å„²å­˜", 'success'); }
        
        function renderAttendanceHistory() { 
            const list = document.getElementById('attendance-history-list'); if(list) list.innerHTML = appState.attendanceHistory.slice().reverse().map((r, i) => { const present = Object.values(r.records).filter(s => s === 'present').length; const absent = Object.values(r.records).filter(s => s === 'absent').length; return `<div class="flex justify-between items-center bg-white p-2 rounded border hover:bg-slate-50"><div><div class="font-bold text-sm">${r.date}</div><div class="text-xs text-slate-500">å‡ºå¸­: ${present} | ç¼ºå¸­: ${absent}</div></div><button onclick="deleteAttendance(${appState.attendanceHistory.length - 1 - i})" class="text-red-500 hover:text-red-700 text-xs font-bold">åˆªé™¤</button></div>`; }).join(''); 
            const alertList = document.getElementById('attendance-alert-list'); 
            if(alertList) { 
                const absentCounts = {}; 
                appState.attendanceHistory.forEach(h => { for(const [name, status] of Object.entries(h.records)) { if(status === 'absent') absentCounts[name] = (absentCounts[name] || 0) + 1; } }); 
                const offenders = Object.entries(absentCounts).filter(([_, c]) => c >= 2).sort((a,b) => b[1] - a[1]); 
                alertList.innerHTML = offenders.length === 0 ? '<div class="text-xs text-green-600 text-center">ç›®å‰ç„¡äººé”åˆ°ç¦è³½æ¨™æº– ğŸ‘</div>' : offenders.map(([name, count]) => `<div class="flex justify-between items-center border-b border-red-100 pb-1 last:border-0"><span class="font-bold text-slate-700 text-sm">${name}</span><span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs font-bold">${count} æ¬¡</span></div>`).join(''); 
            } 
        }
        function deleteAttendance(index) { if(!confirm("ç¢ºå®šåˆªé™¤æ­¤è¨˜éŒ„ï¼Ÿ")) return; appState.attendanceHistory.splice(index, 1); localStorage.setItem('jQt_attendance', JSON.stringify(appState.attendanceHistory)); renderAttendanceHistory(); }
        
        function togglePrefMode() { 
            const checkbox = document.getElementById('toggle-pref'); 
            appState.prioritizePreferences = checkbox.checked; 
            runTeamLogic(appState.lastLogicMode); 
            if (appState.prioritizePreferences) { showToast("å·²é–‹å•Ÿï¼šå„ªå…ˆéµå¾ªå¿—é¡˜", "info"); } 
            else { showToast("å·²é—œé–‰ï¼šåƒ…ä¾æˆ°åŠ›å¹³è¡¡", "info"); } 
        }
        
        function toggleAbsentList() { 
            appState.isAbsentExpanded = !appState.isAbsentExpanded; 
            renderDashboard(); 
        }

        function showHoverCard(e, name, power, rank, teamCount, totalAlliancePower, tierObj) {
            const tooltip = document.getElementById('member-tooltip');
            const pct = totalAlliancePower > 0 ? ((power / totalAlliancePower) * 100).toFixed(2) + '%' : '0%';
            
            // å–å¾—æˆå“¡è³‡æ–™
            const p = appState.players.find(x => x.name === name);
            const fid = p ? p.fid : '';
            // ğŸŸ¢ å–å¾—åŸå§‹å¿—é¡˜ï¼Œè‹¥ç„¡å‰‡é¡¯ç¤º "ç„¡"
            const origPref = p ? (p.origPref || 'ç„¡') : 'ç„¡'; 

            setText('tip-name', name); 
            setText('tip-fid', fid ? `Family: ${fid}` : '');
            
            // ğŸŸ¢ è¨­å®šåŸå§‹å¿—é¡˜æ–‡å­—
            setText('tip-orig-pref', origPref);

            try { 
                const teamName = e.target.closest('.team-container').querySelector('h3').innerText; 
                setText('tip-team', teamName); 
            } catch(err) { setText('tip-team', 'Team'); }
            
            setText('tip-power', formatSmart(power)); 
            setText('tip-rank', '#' + rank); 
            setText('tip-total', '/ ' + teamCount); 
            setText('tip-pct', pct);

            const qEl = document.getElementById('tip-quality');
            if(tierObj) { 
                qEl.innerHTML = `<span class="material-symbols-rounded text-xl align-middle mr-1">${tierObj.icon}</span>${tierObj.label}`; 
                qEl.className = `font-black text-lg flex items-center justify-end ${tierObj.textClass}`; 
            }
            
            tooltip.classList.remove('opacity-0', 'scale-95'); 
            tooltip.classList.add('opacity-100', 'scale-100'); 
            moveTooltip(e);
        }
        
        function moveTooltip(e) {
            const tooltip = document.getElementById('member-tooltip'); if (tooltip.classList.contains('opacity-0')) return;
            let x = e.clientX + 15; let y = e.clientY + 15;
            if (x + 290 > window.innerWidth) x = e.clientX - 290 - 15; if (y + 250 > window.innerHeight) y = e.clientY - 250 - 15;
            tooltip.style.left = x + 'px'; tooltip.style.top = y + 'px';
        }
        function hideHoverCard() { const tooltip = document.getElementById('member-tooltip'); tooltip.classList.remove('opacity-100', 'scale-100'); tooltip.classList.add('opacity-0', 'scale-95'); }

        // Team Modal
        function toggleTeamModal() { const modal = document.getElementById('team-modal'); if (modal.classList.contains('hidden')) { renderTeamSelection(); modal.classList.remove('hidden'); } else { modal.classList.add('hidden'); } }
        function renderTeamSelection() { document.getElementById('team-select-container').innerHTML = appState.teams.map((t, idx) => `<div class="team-select-card ${t.active ? 'selected' : ''}" onclick="toggleTeamActive(${idx})"><div class="flex items-center gap-3"><span class="text-2xl">${t.id.includes('jQt') ? 'ğŸ›¡ï¸' : 'âš”ï¸'}</span><div><div class="font-bold text-slate-800 dark:text-slate-200">${t.name}</div><div class="text-xs text-slate-500">${t.time}</div></div></div><div class="w-6 h-6 rounded border flex items-center justify-center ${t.active ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-slate-300'}">${t.active ? 'âœ“' : ''}</div></div>`).join(''); }
        function toggleTeamActive(idx) { appState.teams[idx].active = !appState.teams[idx].active; renderTeamSelection(); }
        function toggleAllTeams(state) { appState.teams.forEach(t => t.active = state); renderTeamSelection(); }
        function applyTeamSelection() { toggleTeamModal(); runTeamLogic(appState.lastLogicMode || 'snake'); showToast('è»åœ˜è¨­å®šå·²æ›´æ–°', 'success'); }

        // --- è¨ˆç®—æˆ°åŠ›åˆ†ä½ˆèˆ‡ M å‹æŒ‡æ¨™ ---
        function getPowerDistribution(members) {
            if (!members || members.length === 0) return { counts: [0,0,0,0,0], mRatio: 0, ranges: [] };
            
            const powers = members.map(m => m.power);
            const max = Math.max(...powers);
            const min = Math.min(...powers);
            const range = max - min;
            const counts = [0, 0, 0, 0, 0]; // 5 å€‹å€é–“ï¼šé«˜ -> ä½
            
            // å¦‚æœæ‰€æœ‰äººæˆ°åŠ›éƒ½ä¸€æ¨£ï¼Œå…¨éƒ¨ç®—åœ¨ä¸­é–“
            if (range === 0) {
                counts[2] = members.length;
            } else {
                const step = range / 5;
                powers.forEach(p => {
                    // è¨ˆç®—è½åœ¨ç¬¬å¹¾å€‹å€é–“ (0=æœ€é«˜, 4=æœ€ä½)
                    let idx = Math.floor((max - p) / step);
                    if (idx >= 5) idx = 4; // ä¿®æ­£é‚Šç•Œå€¼
                    counts[idx]++;
                });
            }

            // è¨ˆç®— M å‹ä½”æ¯”ï¼š(é ­éƒ¨äººæ•¸ + å°¾éƒ¨äººæ•¸) / ç¸½äººæ•¸
            // é€™ä»£è¡¨ã€Œæ¥µç«¯æˆ°åŠ›ã€çš„æ¯”ä¾‹
            const mRatio = Math.round(((counts[0] + counts[4]) / members.length) * 100);
            
            return { counts, mRatio };
        }

        // Render Dashboard (Final)
       function renderDashboard(){
            setText('stat-n', appState.players.length);
            setText('stat-power', Math.round(appState.players.reduce((a,b)=>a+b.power,0)).toLocaleString());
            setText('stat-unknown', appState.unknownPlayers.length);
            
            let mismatchCount = 0;
            appState.teams.filter(t=>t.active).forEach(t => {
                t.members.forEach(m => {
                    if (m.prefTime !== 'any' && m.prefTime !== t.time) mismatchCount++;
                });
            });
            setText('stat-pref-mismatch', mismatchCount);

            const d=document.getElementById('dashboard-container'); if(d) d.innerHTML='';
            let anyLow = false; renderChart();

            const allPlayersSorted = [...appState.players].sort((a,b) => b.power - a.power);
            const totalGlobalPlayers = allPlayersSorted.length || 1; 
            const globalRankMap = {}; allPlayersSorted.forEach((p, i) => { globalRankMap[p.name] = i + 1; });
            const allianceTotalPower = appState.players.reduce((a,b)=>a+b.power,0);

            appState.teams.forEach(t=>{
                if(!t.active) return;
                if(t.members.length < 15) anyLow = true;
                t.members.sort((a,b)=>b.power-a.power);
                
                // --- è¨ˆç®— M å‹æŒ‡æ¨™ ---
                const { mRatio } = getPowerDistribution(t.members);
                // æ ¹æ“š M å€¼çµ¦äºˆé¡è‰²è©•åƒ¹ (å¤§æ–¼ 40% è¦–ç‚ºé¡¯è‘— M å‹åŒ–)
                let mColor = 'text-slate-400';
                if (mRatio >= 40) mColor = 'text-red-500 font-bold';
                else if (mRatio >= 20) mColor = 'text-amber-500';

                let h = `<div class="team-container border-${t.id.includes('jQt')?'blue':'orange'}-200 animate-slide-up">`;
                
                // ä¿®æ”¹ Header å€å¡Šï¼šåŠ å…¥ M å‹ä½”æ¯”é¡¯ç¤º
                h += `
                <div class="team-col-header flex justify-between items-center">
                    <div>
                        <h3 class="font-black text-lg text-slate-800">${t.name}</h3>
                        <div class="flex gap-2 text-xs font-bold mt-1">
                            <span class="bg-slate-200 px-1.5 py-0.5 rounded text-slate-600">${t.time}</span>
                            <span class="bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded">${t.members.length} äºº</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-black text-slate-700">${Math.round(t.members.reduce((a,b)=>a+b.power,0)/1000).toLocaleString()}k</div>
                        <div class="flex items-center justify-end gap-2">
                            <span class="text-[10px] ${mColor}">Må‹: ${mRatio}%</span>
                            <div class="h-8 w-16"><canvas id="chart-${t.id}"></canvas></div>
                        </div>
                    </div>
                </div>`;
                
                h += `<div class="flex-grow overflow-y-auto p-2 custom-scroll space-y-2 relative bg-slate-50/50">`;

                const tCount = t.members.length;
                const maxTeamPower = t.members.length > 0 ? t.members[0].power : 1;

                t.members.forEach((m, idx)=>{
                    const isConflict = appState.conflictMap[m.name];
                    const w = isConflict ? `<span class="mini-badge bg-red-500 text-white animate-pulse">è¡çª</span>` : '';
                    const ok = (m.prefTime === t.time || m.prefTime === 'any') ? '' : `<span class="mini-badge bg-amber-100 text-amber-700">å¿—é¡˜ä¸ç¬¦</span>`;
                    const safeName = m.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    let absCount = 0; appState.attendanceHistory.forEach(h => { if(h.records[m.name] === 'absent') absCount++; });
                    const absBadge = absCount > 0 ? `<span class="mini-badge bg-slate-800 text-white">ç¼º${absCount}</span>` : '';

                    const globalRank = globalRankMap[m.name] || totalGlobalPlayers;
                    const globalPercentile = Math.ceil((globalRank / totalGlobalPlayers) * 100);
                    
                    let tierClass = '', icon = 'brightness_1', iconColor = 'text-slate-300';
                    let tierText = 'å¤§ä½¬æ•‘æˆ‘';

                    if (globalPercentile <= 10) { tierClass = 'border-l-4 border-l-yellow-400 shadow-[0_2px_8px_rgba(250,204,21,0.15)]'; icon = 'grade'; iconColor = 'text-yellow-400'; tierText = 'çˆ†å¹¹å¼·'; } 
                    else if (globalPercentile <= 25) { tierClass = 'border-l-4 border-l-purple-500'; icon = 'stars'; iconColor = 'text-purple-500'; tierText = 'è¶…ç´šå¼·'; } 
                    else if (globalPercentile <= 50) { tierClass = 'border-l-4 border-l-blue-400'; icon = 'diamond'; iconColor = 'text-blue-400'; tierText = 'å¼·'; } 
                    else if (globalPercentile <= 75) { tierClass = 'border-l-4 border-l-green-500'; icon = 'verified'; iconColor = 'text-green-500'; tierText = 'æ™®é€šå¼±'; }
                    
                    if(isConflict) tierClass = 'border-2 border-red-500 bg-red-50 animate-pulse';

                    const powerPct = Math.max(5, (m.power / maxTeamPower) * 100);
                    const barColor = t.id.includes('jQt') ? 'text-blue-400' : 'text-orange-400';
                    const tierJson = JSON.stringify({icon, label: tierText, textClass: iconColor}).replace(/"/g, "&quot;");

                    h += `
                    <div class="member-card ${tierClass}" onclick="event.stopPropagation(); cycleTeam('${safeName}')" onmousemove="moveTooltip(event)" onmouseenter="showHoverCard(event, '${safeName}', ${m.power}, ${idx+1}, ${tCount}, ${allianceTotalPower}, ${tierJson})" onmouseleave="hideHoverCard()">
                        <div class="power-bar-bg ${barColor}" style="width: ${powerPct}%"></div>
                        <div class="relative z-10 flex justify-between items-center">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <span class="material-symbols-rounded text-sm ${iconColor}">${icon}</span>
                                <span class="member-name font-bold text-slate-700 text-sm truncate w-24">${m.name}</span>
                                ${w}${absBadge}${ok}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-mono text-xs font-bold text-slate-500">${Math.round(m.power/1000).toLocaleString()}k</span>
                                <button class="text-slate-300 hover:text-red-500 transition-colors" onclick="event.stopPropagation(); manualRemove('${safeName}')"><span class="material-symbols-rounded text-base">close</span></button>
                            </div>
                        </div>
                    </div>`;
                });
                h += `</div></div>`; if(d) d.innerHTML+=h;
            });
            setTimeout(() => { appState.teams.forEach(t => { if(t.active) createTeamChart(t); }); }, 50);
            
            const absentPanel = document.getElementById('absent-panel');
            if(absentPanel){
                // ... (ç¼ºå¸­åå–®ä»£ç¢¼ä¿æŒä¸è®Š) ...
                const count = appState.absentPlayers.length;
                if(count > 0){
                    absentPanel.classList.remove('hidden');
                    const arrowClass = appState.isAbsentExpanded ? 'rotate-180' : '';
                    const listClass = appState.isAbsentExpanded ? 'max-h-48 opacity-100 mt-2' : 'max-h-0 opacity-0 overflow-hidden mt-0';
                    const listHtml = appState.absentPlayers.map(p => {
                        const isManual = p.opt === 'æ‰‹å‹•ç§»é™¤';
                        const safeName = p.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        return `<span class="bg-white border border-slate-200 px-2 py-1 rounded-md text-slate-500 flex items-center gap-1 hover:border-blue-300 transition-colors">${p.name} ${isManual ? `<button class="text-blue-500 hover:text-blue-700 font-bold ml-1" onclick="manualRestore('${safeName}')">â†©</button>` : ''}</span>`;
                    }).join('');
                    absentPanel.innerHTML = `
                        <div class="flex items-center justify-between cursor-pointer select-none hover:bg-slate-100 p-1 -m-1 rounded transition-colors" onclick="toggleAbsentList()">
                            <h4 class="font-bold text-slate-600 text-xs flex items-center gap-1">
                                <span class="material-symbols-rounded text-sm">block</span> 
                                ä¸åƒåŠ åå–® (<span id="absent-count">${count}</span>)
                            </h4>
                            <span class="material-symbols-rounded text-slate-400 text-sm transform transition-transform duration-300 ${arrowClass}">keyboard_arrow_down</span>
                        </div>
                        <div id="absent-list" class="flex flex-wrap gap-2 overflow-y-auto custom-scroll text-xs transition-all duration-300 ease-in-out ${listClass}">
                            ${listHtml}
                        </div>
                    `;
                } else { 
                    absentPanel.classList.add('hidden'); absentPanel.innerHTML = ''; 
                }
            }
            const popAlert = document.getElementById('pop-alert');
            if(popAlert) { if(anyLow) { popAlert.innerHTML = "<span class='material-symbols-rounded text-red-600'>error</span> <span>è­¦å‘Šï¼šæœ‰éšŠä¼æœªæ»¿ 15 äººï¼Œç„¡æ³•é–‹å•Ÿæ´»å‹•ï¼</span>"; popAlert.classList.remove('hidden'); } else { popAlert.classList.add('hidden'); } }
            const linkerPanel = document.getElementById('linker-panel');
            if (linkerPanel) linkerPanel.classList.toggle('hidden', appState.unknownPlayers.length === 0);
        }
    </script>
</body>
</html>
